<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendrier ‚Äî F√™te Express</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --bg-dark: #0f172a;
            --bg-light: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.6);
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f3a 50%, var(--bg-dark) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animated {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-animated::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            top: -250px;
            left: -250px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        .bg-animated::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            bottom: -200px;
            right: -200px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Mode clair */
        [data-theme="light"] body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }
        
        /* Mode sombre */
        [data-theme="dark"] body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }
        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-strong {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        .header-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.3);
        }
        .sidebar {
            width: 280px;
            min-height: calc(100vh - 2rem);
            transition: transform 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .sidebar-item {
            transition: all 0.3s ease;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .sidebar-item:hover {
            background-color: rgba(99, 102, 241, 0.1);
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background-color: rgba(99, 102, 241, 0.15);
            border-left: 3px solid var(--primary);
        }

        .sidebar-item.active::before {
            transform: scaleY(1);
        }
        /* Styles pour les onglets Settings */
        .settings-tab-btn {
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .settings-tab-btn:hover {
            color: var(--primary);
            border-bottom-color: rgba(99, 102, 241, 0.5);
        }
        .settings-tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary) !important;
            font-weight: 600;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .calendar-day {
            min-height: 150px;
        }
        /* Styles pour les textareas de messages */
        textarea {
            color: white !important;
            background-color: var(--bg-dark) !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
            transition: all 0.3s ease;
        }
        textarea:focus {
            outline: none !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2) !important;
            background-color: rgba(15, 23, 42, 0.8) !important;
        }
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        /* Style pour les cartes de messages */
        .message-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
            border-radius: 12px;
        }

        .message-card:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
            border-left-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }
        /* Modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 600px;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        /* Style pour les boutons d'envoi */
        .send-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .send-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .send-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .send-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
        /* Scrollbar personnalis√©e */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--primary));
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                min-height: auto;
            }
        }
        
        /* Styles Bootstrap pour les alertes */
        .alert {
            position: relative;
            padding: 1rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.375rem;
        }
        
        .alert-primary {
            color: #084298;
            background-color: #cfe2ff;
            border-color: #b6d4fe;
        }
        
        .alert-secondary {
            color: #41464b;
            background-color: #e2e3e5;
            border-color: #d3d6d8;
        }
        
        .alert-success {
            color: #0f5132;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }
        
        .alert-danger {
            color: #842029;
            background-color: #f8d7da;
            border-color: #f5c2c7;
        }
        
        .alert-warning {
            color: #664d03;
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        
        .alert-info {
            color: #055160;
            background-color: #cff4fc;
            border-color: #b6effb;
        }
        
        .alert-light {
            color: #636464;
            background-color: #fefefe;
            border-color: #fdfdfe;
        }
        
        .alert-dark {
            color: #141619;
            background-color: #d3d3d4;
            border-color: #bcbebf;
        }
        
        /* Mode sombre pour les alertes */
        [data-theme="dark"] .alert-primary,
        body:not([data-theme="light"]) .alert-primary {
            color: #cfe2ff;
            background-color: rgba(13, 110, 253, 0.2);
            border-color: rgba(13, 110, 253, 0.4);
        }
        
        [data-theme="dark"] .alert-secondary,
        body:not([data-theme="light"]) .alert-secondary {
            color: #e2e3e5;
            background-color: rgba(108, 117, 125, 0.2);
            border-color: rgba(108, 117, 125, 0.4);
        }
        
        [data-theme="dark"] .alert-success,
        body:not([data-theme="light"]) .alert-success {
            color: #d1e7dd;
            background-color: rgba(25, 135, 84, 0.2);
            border-color: rgba(25, 135, 84, 0.4);
        }
        
        [data-theme="dark"] .alert-danger,
        body:not([data-theme="light"]) .alert-danger {
            color: #f8d7da;
            background-color: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.4);
        }
        
        [data-theme="dark"] .alert-warning,
        body:not([data-theme="light"]) .alert-warning {
            color: #fff3cd;
            background-color: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
        }
        
        [data-theme="dark"] .alert-info,
        body:not([data-theme="light"]) .alert-info {
            color: #cff4fc;
            background-color: rgba(13, 202, 240, 0.2);
            border-color: rgba(13, 202, 240, 0.4);
        }
        
        [data-theme="dark"] .alert-light,
        body:not([data-theme="light"]) .alert-light {
            color: #fefefe;
            background-color: rgba(248, 249, 250, 0.1);
            border-color: rgba(248, 249, 250, 0.2);
        }
        
        [data-theme="dark"] .alert-dark,
        body:not([data-theme="light"]) .alert-dark {
            color: #d3d3d4;
            background-color: rgba(33, 37, 41, 0.3);
            border-color: rgba(33, 37, 41, 0.5);
        }
        
        .alert-heading {
            margin-bottom: 0.5rem;
        }
        
        .alert-link {
            font-weight: 700;
            text-decoration: underline;
        }
        
        .alert-primary .alert-link {
            color: #06357a;
        }
        
        .alert-secondary .alert-link {
            color: #2d2e30;
        }
        
        .alert-success .alert-link {
            color: #0a3622;
        }
        
        .alert-danger .alert-link {
            color: #6a1a21;
        }
        
        .alert-warning .alert-link {
            color: #533f03;
        }
        
        .alert-info .alert-link {
            color: #04414d;
        }
        
        .alert-light .alert-link {
            color: #51585a;
        }
        
        .alert-dark .alert-link {
            color: #0f1113;
        }
    </style>
</head>

<body class="p-4 md:p-8">
    
    <!-- Animated Background -->
    <div class="bg-animated"></div>
    
    <!-- √âcran de chargement -->
    <div id="loadingScreen" class="fixed inset-0 flex flex-col justify-center items-center z-50" style="background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f3a 50%, var(--bg-dark) 100%);">
        <div class="text-xl text-white mb-4">Chargement du calendrier...</div>
        <div class="loading my-4 flex space-x-2">
            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 animate-bounce"></div>
            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 animate-bounce delay-150"></div>
            <div class="w-4 h-4 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 animate-bounce delay-300"></div>
        </div>
    </div>

    <!-- Contenu principal -->
    <main id="mainContent" class="hidden flex flex-col md:flex-row gap-6 relative z-10">
        <!-- Sidebar -->
        <aside class="sidebar glass-strong p-6 rounded-2xl">
            <div class="mb-6">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i data-lucide="gift" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                    <h2 class="text-xl font-black">
                            <span class="header-gradient">F√™tes Express</span>
                    </h2>
                        <p class="text-xs text-gray-400">Propuls√© par ONTech-Cloud Technology</p>
                    </div>
                </div>
                <nav class="space-y-2">
                    <button onclick="showView('calendrier')" id="btnCalendrier" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span>Calendrier</span>
                    </button>
                    <button onclick="showView('notifications')" id="btnNotifications" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3 relative">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span>Messages</span>
                        <span id="notificationBadge" class="hidden ml-auto bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </button>
                    <button onclick="showView('defis')" id="btnDefis" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="target" class="w-5 h-5"></i>
                        <span>D√©fis</span>
                    </button>
                    <button onclick="showView('settings')" id="btnSettings" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span>Param√®tres</span>
                    </button>
                </nav>
            </div>
            
            <div class="mt-auto pt-6 border-t border-gray-700">
                <div class="glass p-4 rounded-lg">
                    <div class="flex items-center space-x-3 mb-3">
                        <img id="headerProfilePhoto" src="" alt="Photo de profil" class="w-12 h-12 rounded-full object-cover border-2 border-indigo-500 shadow-lg" style="display: none;">
                        <div id="headerProfilePhotoPlaceholder" class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center border-2 border-indigo-500 shadow-lg">
                            <i data-lucide="user" class="w-6 h-6 text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-500">Connect√©</p>
                            <p id="welcomeName" class="text-sm font-semibold text-white truncate"></p>
                        </div>
                    </div>
                <div class="flex flex-col space-y-2">
                    <button onclick="goToAdmin()" id="adminBtn" class="hidden flex items-center justify-center text-sm px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 transition transform hover:scale-105 shadow-lg">
                        <i data-lucide="shield" class="w-4 h-4 mr-2"></i>
                        Admin
                    </button>
                    <button onclick="signOutAndRedirect()" class="flex items-center justify-center text-sm px-4 py-2 rounded-lg bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 transition transform hover:scale-105 shadow-lg">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                        D√©connexion
                    </button>
                </div>
            </div>
        </aside>

        <!-- Contenu principal -->
        <div class="flex-1">
            <header class="mb-6 fade-in">
                <div class="flex items-center space-x-4 mb-2">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                        <i data-lucide="cake" class="w-7 h-7 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-black">
                            <span class="header-gradient" id="pageTitle">Calendrier des Anniversaires</span>
                        </h1>
                        <p class="text-sm text-gray-400 mt-1">F√™te Express ‚Äî Classe 203</p>
                    </div>
                </div>
            </header>

            <!-- Annonces -->
            <div id="announcementsBanner" class="mb-6 space-y-3"></div>

            <!-- Vue Calendrier -->
            <section id="viewCalendrier" class="card p-6 rounded-xl">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i data-lucide="calendar" class="w-6 h-6 mr-2"></i>
                        Calendrier des Anniversaires
                    </h2>
                    <button onclick="exportCalendar()" class="flex items-center px-4 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                        <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                        Exporter
                    </button>
                </div>
                
                <!-- Contr√¥les de vue du calendrier -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <button onclick="changeCalendarView('month')" id="btnViewMonth" class="px-4 py-2 rounded-lg bg-primary bg-opacity-20 text-primary font-semibold border-2 border-primary transition">
                            <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>
                            Mois
                        </button>
                        <button onclick="changeCalendarView('week')" id="btnViewWeek" class="px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-primary hover:bg-opacity-10 transition">
                            <i data-lucide="calendar-days" class="w-4 h-4 inline mr-2"></i>
                            Semaine
                        </button>
                        <button onclick="changeCalendarView('year')" id="btnViewYear" class="px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-primary hover:bg-opacity-10 transition">
                            <i data-lucide="calendar-range" class="w-4 h-4 inline mr-2"></i>
                            Ann√©e
                        </button>
                    </div>
                    <div class="flex items-center space-x-4" id="calendarNavigation">
                        <!-- Navigation sera ajout√©e dynamiquement -->
                    </div>
                </div>
                
                <div id="calendarContainer">
                    <p class="text-gray-500 text-center py-8">Chargement du calendrier...</p>
                </div>
            </section>

            <!-- Vue Messages -->
            <section id="viewNotifications" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i data-lucide="bell" class="w-6 h-6 mr-2"></i>
                    Mes Messages
                </h2>
                
                <!-- Messages Re√ßus -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">Messages re√ßus</h3>
                </div>
                
                <!-- Section pour envoyer des messages (si anniversaire dans 1 semaine ou moins) -->
                <div id="sendMessageSection" class="mb-6 hidden">
                    <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4 mb-4">
                        <h3 class="font-bold mb-2 flex items-center">
                            <i data-lucide="gift" class="w-5 h-5 mr-2"></i>
                            Anniversaires √† venir (dans 1 semaine ou moins)
                        </h3>
                        <p class="text-sm text-gray-300 mb-4">Tu peux envoyer un message secret ou public √† ces personnes pour leur souhaiter un joyeux anniversaire !</p>
                        <div id="upcomingBirthdays" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Explication si la f√™te n'a pas encore pass√© -->
                <div id="birthdayExplanation" class="bg-gradient-to-r from-primary to-secondary bg-opacity-20 border border-primary rounded-lg p-4 mb-6 hidden">
                    <h3 class="font-bold mb-2 flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                        Comment √ßa marche ?
                    </h3>
                    <p class="text-sm">
                        <strong>Ton anniversaire approche !</strong> Quand ton anniversaire est dans 1 semaine ou moins, 
                        tes camarades peuvent t'envoyer des messages secrets ou publics pour te souhaiter un joyeux anniversaire. 
                        Tu recevras ces messages ici dans tes messages. Les messages secrets restent priv√©s, 
                        tandis que les messages publics peuvent √™tre vus par tous. üéâ
                    </p>
                </div>

                <!-- Vue Messages Re√ßus -->
                <div id="messagesReceivedView">
                <div class="mb-4">
                    <div id="messagesList" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Chargement de tes messages...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vue D√©fis -->
            <section id="viewDefis" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="target" class="w-6 h-6 mr-2"></i>
                    D√©fis
                </h2>
                
                <!-- Onglets -->
                <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-700">
                    <button onclick="showDefisTab('progression')" id="defisTabProgression" class="px-4 py-2 rounded-t-lg bg-primary bg-opacity-20 text-primary font-semibold border-b-2 border-primary">
                        Progression
                    </button>
                    <button onclick="showDefisTab('vote')" id="defisTabVote" class="px-4 py-2 rounded-t-lg text-gray-400 hover:text-white transition">
                        Vote Activit√©s
                    </button>
                </div>

                <!-- Onglet Progression -->
                <div id="defisProgressionView">
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">Objectif : 9 Personnes Cons√©cutives</h3>
                            <div id="consecutiveCount" class="text-4xl font-bold text-primary">0</div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-8 mb-4 relative">
                            <div id="progressFill" class="bg-gradient-to-r from-primary to-secondary h-8 rounded-full transition-all duration-500" style="width: 0%"></div>
                            <div class="absolute inset-0 flex items-center justify-center font-bold text-sm">
                                <span id="progressText">0 / 9</span>
                            </div>
                        </div>
                        <p id="progressMessage" class="text-gray-400 text-sm">Chargement...</p>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold mb-4">D√©tails par Personne</h3>
                        <div id="progressionContent" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Onglet Vote Activit√©s -->
                <div id="defisVoteView" class="hidden">
                    <div id="voteContent">
                        <p class="text-gray-500 text-center py-8">Chargement...</p>
                    </div>
                </div>
            </section>


            <!-- Vue Param√®tres -->
            <section id="viewSettings" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="settings" class="w-6 h-6 mr-2"></i>
                    Param√®tres
                </h2>
                
                <!-- Onglets de navigation -->
                <div class="mb-6 border-b border-gray-700">
                    <div class="flex flex-wrap gap-2 -mb-px">
                        <button 
                            onclick="switchSettingsTab('profile')" 
                            id="settingsTabProfile" 
                            class="settings-tab-btn px-6 py-3 font-semibold text-sm rounded-t-lg transition-all border-b-2 border-transparent hover:border-primary hover:text-primary flex items-center space-x-2 active"
                        >
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <span>Mon Profil</span>
                        </button>
                        <button 
                            onclick="switchSettingsTab('wishlist')" 
                            id="settingsTabWishlist" 
                            class="settings-tab-btn px-6 py-3 font-semibold text-sm rounded-t-lg transition-all border-b-2 border-transparent hover:border-primary hover:text-primary flex items-center space-x-2"
                        >
                            <i data-lucide="gift" class="w-5 h-5"></i>
                            <span>Souhaits de Cadeau</span>
                        </button>
                        <button 
                            onclick="switchSettingsTab('preferences')" 
                            id="settingsTabPreferences" 
                            class="settings-tab-btn px-6 py-3 font-semibold text-sm rounded-t-lg transition-all border-b-2 border-transparent hover:border-primary hover:text-primary flex items-center space-x-2"
                        >
                            <i data-lucide="sliders" class="w-5 h-5"></i>
                            <span>Pr√©f√©rences</span>
                        </button>
                    </div>
                </div>

                <!-- Section Mon Profil -->
                <div id="settingsSectionProfile" class="settings-section">
                    <!-- Photo de profil -->
                    <div class="mb-8 text-center">
                        <div class="relative inline-block">
                            <img id="profilePhoto" src="" alt="Photo de profil" class="w-32 h-32 rounded-full object-cover border-4 border-primary mx-auto mb-4" style="display: none;">
                            <div id="profilePhotoPlaceholder" class="w-32 h-32 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-4xl mx-auto mb-4 border-4 border-primary">
                                <i data-lucide="user" class="w-16 h-16 text-white"></i>
                            </div>
                            <label for="profilePhotoInput" class="absolute bottom-0 right-0 bg-primary hover:bg-opacity-90 text-white p-2 rounded-full cursor-pointer transition">
                                <i data-lucide="camera" class="w-5 h-5"></i>
                                <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" onchange="handleProfilePhotoUpload(event)">
                            </label>
                        </div>
                        <p class="text-sm text-gray-400 mb-4">Clique sur l'ic√¥ne cam√©ra pour changer ta photo</p>
                        <div id="photoUploadStatus" class="hidden"></div>
                    </div>

                    <!-- Informations du profil -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                            Mes Informations
                        </h3>
                        <div id="myProfileContent" class="mb-6">
                            <p class="text-gray-500 text-center py-8">Chargement...</p>
                        </div>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="openEditProfileModal()" class="flex items-center px-6 py-3 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                <i data-lucide="edit" class="w-5 h-5 mr-2"></i>
                                Modifier mon profil
                            </button>
                            <button onclick="openVisibilityModal()" class="flex items-center px-6 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition">
                                <i data-lucide="eye" class="w-5 h-5 mr-2"></i>
                                Modifier la visibilit√©
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section Liste de Souhaits -->
                <div id="settingsSectionWishlist" class="settings-section hidden">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="gift" class="w-5 h-5 mr-2"></i>
                            Ma Liste de Souhaits
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">Ajoute tes souhaits d'anniversaire ici. Les autres pourront les voir si tu le permets.</p>
                        
                        <!-- Ajouter un souhait -->
                        <div class="mb-4">
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="settingsWishInput" 
                                    placeholder="Ex: Un nouveau livre, des √©couteurs..." 
                                    class="flex-1 px-4 py-2 rounded-lg bg-bg-dark border border-gray-700 text-white focus:outline-none focus:border-primary transition"
                                />
                                <button onclick="addWishFromSettings()" class="px-6 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Visibilit√© -->
                        <div class="mb-4 p-4 bg-bg-dark rounded-lg border border-gray-700">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold mb-1">Rendre ma liste visible</p>
                                    <p class="text-sm text-gray-400">Les autres √©l√®ves pourront voir tes souhaits</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="settingsWishlistVisibilityToggle" onchange="toggleWishlistVisibilityFromSettings()" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                </label>
                            </div>
                        </div>

                        <!-- Liste des souhaits -->
                        <div id="settingsWishlistContent">
                            <p class="text-gray-500 text-center py-8">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Section Pr√©f√©rences -->
                <div id="settingsSectionPreferences" class="settings-section hidden">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i data-lucide="sliders" class="w-5 h-5 mr-2"></i>
                            Pr√©f√©rences
                        </h3>
                        <div class="space-y-4">
                            <!-- Mode sombre/clair -->
                            <div class="bg-bg-dark p-4 rounded-lg border border-gray-700">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold mb-1">Th√®me</h4>
                                        <p class="text-sm text-gray-400">Choisir entre le mode sombre et clair</p>
                                    </div>
                                    <button onclick="themeManager.toggleTheme()" class="px-4 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                        <i data-lucide="sun" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modale Profil depuis Calendrier -->
    <div id="calendarProfileModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i data-lucide="user" class="w-6 h-6 mr-2"></i>
                    Profil
                </h3>
                <button onclick="closeModal('calendarProfileModal')" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="calendarProfileContent" class="text-center">
                <div class="mb-4">
                    <img id="calendarProfilePhoto" src="" alt="Photo de profil" class="w-24 h-24 rounded-full object-cover border-4 border-primary mx-auto mb-4" style="display: none;">
                    <div id="calendarProfilePhotoPlaceholder" class="w-24 h-24 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-3xl mx-auto mb-4 border-4 border-primary">
                        <i data-lucide="user" class="w-12 h-12 text-white"></i>
                    </div>
                </div>
                <h4 id="calendarProfileName" class="text-xl font-bold mb-2"></h4>
                <p id="calendarProfileEmail" class="text-gray-400 text-sm mb-2"></p>
                <p id="calendarProfileBirthday" class="text-gray-400 text-sm mb-4"></p>
                <button onclick="viewFullProfile()" class="px-4 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                    Voir le profil complet
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Modifier le Profil -->
    <div id="editProfileModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i data-lucide="edit" class="w-6 h-6 mr-2"></i>
                    Modifier mon profil
                </h3>
                <button onclick="closeModal('editProfileModal')" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-400 mb-6 text-sm">
                Pour modifier tes informations, tu dois remplir √† nouveau le formulaire complet.
            </p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeModal('editProfileModal')" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700 transition">
                    Annuler
                </button>
                <button onclick="window.location.href='profile-config.html'" class="px-4 py-2 rounded bg-primary hover:bg-opacity-90 text-white transition">
                    Aller au formulaire
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Modifier la Visibilit√© -->
    <div id="visibilityModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i data-lucide="eye" class="w-6 h-6 mr-2"></i>
                    Modifier la visibilit√© de mes informations
                </h3>
                <button onclick="closeModal('visibilityModal')" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-400 mb-6 text-sm">
                Choisis quelles informations tu veux rendre visibles aux autres √©l√®ves. Les informations priv√©es ne seront visibles que par les administrateurs.
            </p>
            <div id="visibilityModalContent">
                <p class="text-gray-500 text-center py-8">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Inclusion du fichier firebase.js -->
    <script src="firebase.js"></script>
    <!-- Syst√®me de logging automatique des activit√©s -->
    <script src="js/activity-logger.js"></script>
    <!-- Gestionnaire de th√®me (mode sombre/clair) -->
    <script src="js/theme-manager.js"></script>
    <script src="js/progression-system.js"></script>
    <script src="js/vote-system.js"></script>
    <!-- Syst√®me de classements -->
    <script src="js/leaderboard-system.js"></script>
    <!-- Syst√®me d'annonces -->
    <script src="js/announcements-system.js"></script>
    <!-- Syst√®me de liste de souhaits -->
    <script src="js/wishlist-system.js"></script>
    <!-- Syst√®me Supabase Storage pour photos de profil -->
    <script src="js/supabase-storage.js"></script>

    <script>
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContent = document.getElementById('mainContent');
        const welcomeName = document.getElementById('welcomeName');
        const adminBtn = document.getElementById('adminBtn');
        const calendarContainer = document.getElementById('calendarContainer');
        const pageTitle = document.getElementById('pageTitle');
        const notificationBadge = document.getElementById('notificationBadge');
        let allCelebrations = [];
        let currentUserId = null;
        let currentUserBirthday = null;

        // Configuration de l'API Email
        // D√©tection automatique : localhost en d√©veloppement, URL de production sinon
        const EMAIL_API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3001/api'
            : 'https://votre-serveur-email.com/api'; // √Ä configurer pour la production

        /**
         * Envoie une notification par email lorsqu'un message est re√ßu
         * @param {string} email - Email du destinataire
         * @param {string} recipientName - Nom du destinataire
         * @param {string} senderName - Nom de l'exp√©diteur
         * @param {string} message - Contenu du message
         * @param {boolean} isPublic - Si le message est public
         * @param {string} birthdayMessage - Message d'anniversaire optionnel
         * @returns {Promise<boolean>} Succ√®s ou √©chec
         */
        async function sendMessageNotification(email, recipientName, senderName, message, isPublic, birthdayMessage = '') {
            try {
                const response = await fetch(`${EMAIL_API_URL}/send-message-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        recipientName: recipientName,
                        senderName: senderName,
                        message: message,
                        isPublic: isPublic,
                        notificationsUrl: window.location.origin + '/eleve.html#notifications',
                        birthdayMessage: birthdayMessage || ''
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ Notification email envoy√©e √†', email);
                    return true;
                } else {
                    console.error('‚ùå Erreur envoi notification:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'envoi de la notification:', error);
                // Ne pas bloquer l'envoi du message si la notification √©choue
                return false;
            }
        }

        // V√©rifier l'authentification
        async function checkAuth() {
            try {
            loadingScreen.style.display = 'flex';
            
            const user = await new Promise(resolve => {
                const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                    unsubscribe();
                    resolve(u);
                });
            });

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // V√©rifier si le profil est compl√©t√© (seulement pour les √©l√®ves)
            const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
            const docData = userDoc.data();
            if (docData) {
                // Si c'est un √©l√®ve et que le profil n'est pas compl√©t√©, rediriger
                if (docData.role === 'eleve' && !docData.profileCompleted) {
                    window.location.href = 'profile-config.html';
                    return;
                }
            }

            const userData = await getUserRole(user.uid);
            welcomeName.textContent = `Bienvenue, ${userData.name}`;
            currentUserId = user.uid;

            // Charger la photo de profil dans l'en-t√™te
            await loadHeaderProfilePhoto();


            // R√©cup√©rer la date d'anniversaire de l'utilisateur
            if (docData && docData.email) {
                    try {
                const fileNumber = docData.email.split('@')[0];
                const userCelebration = await firebase.firestore().collection('celebrations')
                    .where('fileNumber', '==', fileNumber)
                    .limit(1)
                    .get();
                
                if (!userCelebration.empty) {
                    currentUserBirthday = userCelebration.docs[0].data().birthday;
                        }
                    } catch (celebError) {
                        console.error('Erreur lors de la r√©cup√©ration de l\'anniversaire:', celebError);
                }
            }

            // Afficher le bouton admin si l'utilisateur est admin
            if (userData.role === 'admin') {
                adminBtn.classList.remove('hidden');
            }

                // V√©rifier si la visibilit√© des profils est activ√©e
                try {
                    const settingsDoc = await firebase.firestore().collection('settings').doc('profileVisibility').get();
                    const profileVisibilityEnabled = settingsDoc.exists && settingsDoc.data().enabled || false;
                    
                    if (profileVisibilityEnabled) {
                        const btnOtherProfiles = document.getElementById('settingsTabOtherProfiles');
                        if (btnOtherProfiles) btnOtherProfiles.classList.remove('hidden');
                    }
                } catch (settingsError) {
                    console.error('Erreur lors de la v√©rification des param√®tres:', settingsError);
                }

            loadingScreen.style.display = 'none';
            mainContent.classList.remove('hidden');
            
            loadCelebrations();
            loadNotifications();
                loadAnnouncements();
            // Initialiser le calendrier par d√©faut
            if (!currentCalendarView) {
                currentCalendarView = 'month';
            }
            loadCalendarView();
            } catch (error) {
                console.error('Erreur lors de la v√©rification de l\'authentification:', error);
                // S'assurer que l'√©cran de chargement est masqu√© m√™me en cas d'erreur
                loadingScreen.style.display = 'none';
                mainContent.classList.remove('hidden');
                alert('Une erreur est survenue lors du chargement. Veuillez rafra√Æchir la page.');
            }
        }

        // Calculer l'√¢ge actuel
        function calculateAge(birthday) {
            if (!birthday) return 'N/A';
            const dateParts = birthday.split('-');
            if (dateParts.length !== 3) return 'N/A';
            
            const birthDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Charger les c√©l√©brations
        function loadCelebrations() {
            firebase.firestore().collection('celebrations')
                .orderBy('birthday', 'asc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        celebrationsList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun anniversaire enregistr√© pour le moment.</p>';
                        allCelebrations = [];
                        return;
                    }

                    allCelebrations = [];
                    snapshot.forEach(doc => {
                        allCelebrations.push({ id: doc.id, ...doc.data() });
                    });

                    // Charger la vue actuelle
                    const currentView = document.querySelector('.sidebar-item.active')?.id;
                    if (currentView === 'btnCalendrier') {
                        loadCalendarView();
                    } else if (currentView === 'btnNotifications') {
                        loadNotificationsView();
                    }
                    
                    // Mettre √† jour les notifications
                    loadNotifications();
                }, error => {
                    console.error("Erreur lors du chargement:", error);
                    calendarContainer.innerHTML = '<p class="text-red-400 text-center py-8">Erreur de chargement des donn√©es.</p>';
                });
        }


        // Syst√®me de liste de souhaits
        let wishlistSystem = null;
        // Syst√®me Supabase Storage
        let supabaseStorage = null;

        // Charger la vue de la liste de souhaits
        async function loadWishlistView() {
            if (!currentUserId) {
                document.getElementById('wishlistContent').innerHTML = '<p class="text-red-400 text-center py-8">Erreur : utilisateur non connect√©</p>';
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const wishlist = await wishlistSystem.getWishlist();
                
                // Mettre √† jour le toggle de visibilit√©
                const toggle = document.getElementById('wishlistVisibilityToggle');
                if (toggle) {
                    toggle.checked = wishlist.isPublic || false;
                }

                // Afficher la liste
                const wishlistContent = document.getElementById('wishlistContent');
                
                if (wishlist.items.length === 0) {
                    wishlistContent.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="gift" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                            <p class="text-gray-400 text-lg mb-2">Aucun souhait pour le moment</p>
                            <p class="text-gray-500 text-sm">Ajoute tes souhaits d'anniversaire ci-dessus !</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                wishlistContent.innerHTML = `
                    <div class="space-y-3">
                        ${wishlist.items.map(item => `
                            <div class="flex items-center justify-between p-4 bg-bg-dark rounded-lg border border-gray-700">
                                <p class="text-white flex-1">${item.text}</p>
                                <button onclick="removeWish('${item.id}')" class="ml-4 p-2 rounded-lg bg-red-600 hover:bg-red-700 text-white transition" title="Supprimer">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement de la liste de souhaits:', error);
                document.getElementById('wishlistContent').innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement.</p>';
            }
        }

        // Ajouter un souhait
        window.addWish = async function() {
            const input = document.getElementById('newWishInput');
            const wishText = input.value.trim();

            if (!wishText) {
                alert('Veuillez entrer un souhait');
                return;
            }

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const success = await wishlistSystem.addWish(wishText);
                if (success) {
                    input.value = '';
                    await loadWishlistView();
                } else {
                    alert('Erreur lors de l\'ajout du souhait');
                }
            } catch (error) {
                console.error('Erreur lors de l\'ajout du souhait:', error);
                alert('Erreur lors de l\'ajout du souhait');
            }
        };

        // Supprimer un souhait
        window.removeWish = async function(wishId) {
            if (!confirm('Es-tu s√ªr de vouloir supprimer ce souhait ?')) {
                return;
            }

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const success = await wishlistSystem.removeWish(wishId);
                if (success) {
                    await loadWishlistView();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                alert('Erreur lors de la suppression');
            }
        };

        // Toggle visibilit√©
        window.toggleWishlistVisibility = async function() {
            const toggle = document.getElementById('wishlistVisibilityToggle');
            const isPublic = toggle.checked;

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                toggle.checked = !isPublic;
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const success = await wishlistSystem.setVisibility(isPublic);
                if (!success) {
                    toggle.checked = !isPublic;
                    alert('Erreur lors de la modification');
                }
            } catch (error) {
                console.error('Erreur lors de la modification de la visibilit√©:', error);
                toggle.checked = !isPublic;
                alert('Erreur lors de la modification');
            }
        };

        // Charger les souhaits dans Settings
        async function loadSettingsWishlist() {
            if (!currentUserId) return;

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const wishlist = await wishlistSystem.getWishlist();
                
                // Mettre √† jour le toggle
                const toggle = document.getElementById('settingsWishlistVisibilityToggle');
                if (toggle) {
                    toggle.checked = wishlist.isPublic || false;
                }

                // Afficher la liste
                const wishlistContent = document.getElementById('settingsWishlistContent');
                
                if (wishlist.items.length === 0) {
                    wishlistContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="gift" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p class="text-gray-400 text-sm">Aucun souhait pour le moment</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                wishlistContent.innerHTML = `
                    <div class="space-y-2">
                        ${wishlist.items.map(item => `
                            <div class="flex items-center justify-between p-3 bg-bg-dark rounded-lg border border-gray-700">
                                <p class="text-white flex-1 text-sm">${item.text}</p>
                                <button onclick="removeWishFromSettings('${item.id}')" class="ml-3 p-1.5 rounded-lg bg-red-600 hover:bg-red-700 text-white transition" title="Supprimer">
                                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement des souhaits:', error);
            }
        }

        // Ajouter un souhait depuis Settings
        window.addWishFromSettings = async function() {
            const input = document.getElementById('settingsWishInput');
            const wishText = input.value.trim();

            if (!wishText) {
                alert('Veuillez entrer un souhait');
                return;
            }

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const success = await wishlistSystem.addWish(wishText);
                if (success) {
                    input.value = '';
                    await loadSettingsWishlist();
                } else {
                    alert('Erreur lors de l\'ajout du souhait');
                }
            } catch (error) {
                console.error('Erreur lors de l\'ajout du souhait:', error);
                alert('Erreur lors de l\'ajout du souhait');
            }
        };

        // Supprimer un souhait depuis Settings
        window.removeWishFromSettings = async function(wishId) {
            if (!confirm('Es-tu s√ªr de vouloir supprimer ce souhait ?')) {
                return;
            }

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const success = await wishlistSystem.removeWish(wishId);
                if (success) {
                    await loadSettingsWishlist();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                alert('Erreur lors de la suppression');
            }
        };

        // Toggle visibilit√© depuis Settings
        window.toggleWishlistVisibilityFromSettings = async function() {
            const toggle = document.getElementById('settingsWishlistVisibilityToggle');
            const isPublic = toggle.checked;

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                toggle.checked = !isPublic;
                return;
            }

            try {
                if (!wishlistSystem) {
                    wishlistSystem = new WishlistSystem(currentUserId);
                }

                const success = await wishlistSystem.setVisibility(isPublic);
                if (!success) {
                    toggle.checked = !isPublic;
                    alert('Erreur lors de la modification');
                }
            } catch (error) {
                console.error('Erreur lors de la modification de la visibilit√©:', error);
                toggle.checked = !isPublic;
                alert('Erreur lors de la modification');
            }
        };

        // G√©rer l'upload de photo de profil
        window.handleProfilePhotoUpload = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            const statusDiv = document.getElementById('photoUploadStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<p class="text-blue-400 text-sm">Upload en cours...</p>';

            try {
                if (!supabaseStorage) {
                    supabaseStorage = new SupabaseStorage();
                }

                const photoUrl = await supabaseStorage.uploadProfilePhoto(currentUserId, file);
                
                // Sauvegarder l'URL dans Firestore
                await firebase.firestore().collection('users').doc(currentUserId).update({
                    profilePhotoUrl: photoUrl,
                    profilePhotoUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Afficher la photo
                const profilePhoto = document.getElementById('profilePhoto');
                const placeholder = document.getElementById('profilePhotoPlaceholder');
                profilePhoto.src = photoUrl;
                profilePhoto.style.display = 'block';
                placeholder.style.display = 'none';

                statusDiv.innerHTML = '<p class="text-green-400 text-sm">Photo upload√©e avec succ√®s !</p>';
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 3000);

                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors de l\'upload:', error);
                // Afficher l'erreur de mani√®re plus visible
                const errorMessage = error.message || 'Une erreur est survenue lors de l\'upload';
                statusDiv.innerHTML = `
                    <div class="bg-red-900 bg-opacity-20 border border-red-500 rounded-lg p-4">
                        <div class="flex items-start">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400 mr-2 flex-shrink-0 mt-0.5"></i>
                            <div class="flex-1">
                                <p class="text-red-400 font-semibold mb-2">Erreur lors de l'upload</p>
                                <p class="text-red-300 text-sm whitespace-pre-line">${errorMessage}</p>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                
                // Garder l'erreur visible plus longtemps
                setTimeout(() => {
                    if (statusDiv && statusDiv.parentElement) {
                        statusDiv.classList.remove('hidden');
                    }
                }, 10000);
            }
        };

        // Charger la photo de profil
        async function loadProfilePhoto() {
            if (!currentUserId) return;

            try {
                const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
                const userData = userDoc.data();
                
                if (userData && userData.profilePhotoUrl) {
                    const profilePhoto = document.getElementById('profilePhoto');
                    const placeholder = document.getElementById('profilePhotoPlaceholder');
                    profilePhoto.src = userData.profilePhotoUrl;
                    profilePhoto.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la photo:', error);
            }
        }

        // Charger la photo de profil dans l'en-t√™te
        async function loadHeaderProfilePhoto() {
            if (!currentUserId) return;

            try {
                const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
                const userData = userDoc.data();
                
                const headerPhoto = document.getElementById('headerProfilePhoto');
                const headerPlaceholder = document.getElementById('headerProfilePhotoPlaceholder');
                
                if (userData && userData.profilePhotoUrl) {
                    headerPhoto.src = userData.profilePhotoUrl;
                    headerPhoto.style.display = 'block';
                    headerPlaceholder.style.display = 'none';
                } else {
                    headerPhoto.style.display = 'none';
                    headerPlaceholder.style.display = 'flex';
                }
            } catch (error) {
                console.error('Erreur lors du chargement de la photo dans l\'en-t√™te:', error);
            }
        }

        // Fonction helper pour obtenir la photo de profil d'un utilisateur
        async function getUserProfilePhoto(userId) {
            if (!userId) return null;
            try {
                const userDoc = await firebase.firestore().collection('users').doc(userId).get();
                const userData = userDoc.data();
                return userData?.profilePhotoUrl || null;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration de la photo:', error);
                return null;
            }
        }

        // Variables globales pour le modal de profil
        let currentProfileUserId = null;

        // Afficher le modal de profil depuis le calendrier
        window.showProfileModal = async function(userId, fullName, birthday, email) {
            currentProfileUserId = userId;
            const modal = document.getElementById('calendarProfileModal');
            const nameEl = document.getElementById('calendarProfileName');
            const emailEl = document.getElementById('calendarProfileEmail');
            const birthdayEl = document.getElementById('calendarProfileBirthday');
            const photoEl = document.getElementById('calendarProfilePhoto');
            const placeholderEl = document.getElementById('calendarProfilePhotoPlaceholder');

            // Afficher les informations de base
            nameEl.textContent = fullName || 'N/A';
            emailEl.textContent = email || 'N/A';
            
            // Formater la date d'anniversaire
            if (birthday) {
                const dateParts = birthday.split('-');
                if (dateParts.length === 3) {
                    const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    birthdayEl.textContent = `Anniversaire : ${formattedDate}`;
                } else {
                    birthdayEl.textContent = 'Date d\'anniversaire non disponible';
                }
            } else {
                birthdayEl.textContent = 'Date d\'anniversaire non disponible';
            }

            // Charger la photo de profil si userId disponible
            if (userId) {
                try {
                    const userDoc = await firebase.firestore().collection('users').doc(userId).get();
                    const userData = userDoc.data();
                    
                    if (userData && userData.profilePhotoUrl) {
                        photoEl.src = userData.profilePhotoUrl;
                        photoEl.style.display = 'block';
                        placeholderEl.style.display = 'none';
                    } else {
                        photoEl.style.display = 'none';
                        placeholderEl.style.display = 'flex';
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement de la photo:', error);
                    photoEl.style.display = 'none';
                    placeholderEl.style.display = 'flex';
                }
            } else {
                photoEl.style.display = 'none';
                placeholderEl.style.display = 'flex';
            }

            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        // Voir le profil complet
        window.viewFullProfile = function() {
            if (currentProfileUserId) {
                window.location.href = `student-profile.html?id=${currentProfileUserId}`;
            } else {
                alert('ID utilisateur non disponible');
            }
        };

        // Permettre d'ajouter un souhait avec Enter
        document.addEventListener('DOMContentLoaded', () => {
            const wishInput = document.getElementById('newWishInput');
            if (wishInput) {
                wishInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addWish();
                    }
                });
            }
        });


        // Exporter le calendrier en format iCal
        window.exportCalendar = function() {
            if (allCelebrations.length === 0) {
                alert('Aucun anniversaire √† exporter');
                return;
            }

            // G√©n√©rer le contenu iCal
            let icalContent = 'BEGIN:VCALENDAR\r\n';
            icalContent += 'VERSION:2.0\r\n';
            icalContent += 'PRODID:-//F√™te Express//Anniversaires//FR\r\n';
            icalContent += 'CALSCALE:GREGORIAN\r\n';
            icalContent += 'METHOD:PUBLISH\r\n';

            const currentYear = new Date().getFullYear();
            
            allCelebrations.forEach(celeb => {
                if (!celeb.birthday) return;
                
                const dateParts = celeb.birthday.split('-');
                if (dateParts.length !== 3) return;
                
                const month = dateParts[1];
                const day = dateParts[2];
                const year = currentYear;
                
                // Date de l'anniversaire cette ann√©e
                const eventDate = new Date(year, parseInt(month) - 1, parseInt(day));
                
                // Si l'anniversaire est d√©j√† pass√© cette ann√©e, utiliser l'ann√©e prochaine
                const today = new Date();
                if (eventDate < today) {
                    eventDate.setFullYear(year + 1);
                }
                
                // Formater la date pour iCal (YYYYMMDD)
                const icalDate = eventDate.toISOString().split('T')[0].replace(/-/g, '');
                
                // Nom de l'√©v√©nement
                const summary = `üéÇ Anniversaire de ${celeb.fullName || 'N/A'}`;
                
                // Description
                const age = calculateAge(celeb.birthday);
                const description = `Anniversaire de ${celeb.fullName || 'N/A'} (${age} ans)`;
                
                // G√©n√©rer un UID unique
                const uid = `anniversaire-${celeb.id || Date.now()}-${Math.random().toString(36).substr(2, 9)}@fete-express.com`;
                
                icalContent += 'BEGIN:VEVENT\r\n';
                icalContent += `UID:${uid}\r\n`;
                icalContent += `DTSTART;VALUE=DATE:${icalDate}\r\n`;
                icalContent += `DTEND;VALUE=DATE:${icalDate}\r\n`;
                icalContent += `SUMMARY:${summary}\r\n`;
                icalContent += `DESCRIPTION:${description}\r\n`;
                icalContent += 'RRULE:FREQ=YEARLY;INTERVAL=1\r\n';
                icalContent += 'END:VEVENT\r\n';
            });

            icalContent += 'END:VCALENDAR\r\n';

            // Cr√©er un blob et t√©l√©charger
            const blob = new Blob([icalContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'anniversaires-fete-express.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Calendrier export√© avec succ√®s ! Tu peux l\'importer dans Google Calendar, Apple Calendar ou Outlook.');
        };

        // Variable pour stocker la vue actuelle du calendrier
        let currentCalendarView = 'month';
        let currentCalendarDate = new Date();

        // Changer la vue du calendrier (mois, semaine, ann√©e)
        window.changeCalendarView = function(view) {
            currentCalendarView = view;
            
            // Mettre √† jour les boutons
            document.getElementById('btnViewMonth').className = view === 'month' 
                ? 'px-4 py-2 rounded-lg bg-primary bg-opacity-20 text-primary font-semibold border-2 border-primary transition'
                : 'px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-primary hover:bg-opacity-10 transition';
            document.getElementById('btnViewWeek').className = view === 'week' 
                ? 'px-4 py-2 rounded-lg bg-primary bg-opacity-20 text-primary font-semibold border-2 border-primary transition'
                : 'px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-primary hover:bg-opacity-10 transition';
            document.getElementById('btnViewYear').className = view === 'year' 
                ? 'px-4 py-2 rounded-lg bg-primary bg-opacity-20 text-primary font-semibold border-2 border-primary transition'
                : 'px-4 py-2 rounded-lg text-gray-400 hover:text-white hover:bg-primary hover:bg-opacity-10 transition';
            
            loadCalendarView();
        };

        // Navigation du calendrier
        window.navigateCalendar = function(direction) {
            if (currentCalendarView === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            } else if (currentCalendarView === 'week') {
                currentCalendarDate.setDate(currentCalendarDate.getDate() + (direction * 7));
            } else if (currentCalendarView === 'year') {
                currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() + direction);
            }
            loadCalendarView();
        };

        // Charger la vue calendrier
        async function loadCalendarView() {
            if (allCelebrations.length === 0) {
                calendarContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun anniversaire enregistr√© pour le moment.</p>';
                return;
            }

            // Charger tous les utilisateurs pour avoir acc√®s aux IDs
            const allUsers = await getAllUsers();
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];

            // Organiser les anniversaires par date
            const celebrationsByDate = {};
            allCelebrations.forEach(celeb => {
                if (!celeb.birthday) return;
                const dateParts = celeb.birthday.split('-');
                if (dateParts.length !== 3) return;
                
                const month = parseInt(dateParts[1]) - 1;
                const day = parseInt(dateParts[2]);
                const key = `${month}-${day}`;
                
                if (!celebrationsByDate[key]) {
                    celebrationsByDate[key] = [];
                }
                
                celebrationsByDate[key].push({
                    ...celeb,
                    day: day,
                    month: month,
                    age: calculateAge(celeb.birthday)
                });
            });

            // Mettre √† jour la navigation
            const navContainer = document.getElementById('calendarNavigation');
            let navText = '';
            if (currentCalendarView === 'month') {
                navText = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            } else if (currentCalendarView === 'week') {
                const weekStart = new Date(currentCalendarDate);
                weekStart.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                navText = `${weekStart.getDate()} ${monthNames[weekStart.getMonth()]} - ${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()]} ${weekEnd.getFullYear()}`;
            } else if (currentCalendarView === 'year') {
                navText = currentCalendarDate.getFullYear().toString();
            }
            
            navContainer.innerHTML = `
                <button onclick="navigateCalendar(-1)" class="px-3 py-2 rounded-lg hover:bg-primary hover:bg-opacity-10 transition">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                </button>
                <span class="px-4 py-2 font-semibold">${navText}</span>
                <button onclick="navigateCalendar(1)" class="px-3 py-2 rounded-lg hover:bg-primary hover:bg-opacity-10 transition">
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
                <button onclick="currentCalendarDate = new Date(); loadCalendarView();" class="ml-2 px-3 py-2 rounded-lg hover:bg-primary hover:bg-opacity-10 transition" title="Aujourd'hui">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                </button>
            `;

            calendarContainer.innerHTML = '';
            
            if (currentCalendarView === 'month') {
                // Vue mensuelle - calendrier classique
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();

                let html = `
                    <div class="grid grid-cols-7 gap-2 mb-4">
                        ${dayNames.map(day => `<div class="text-center font-semibold text-gray-400 py-2">${day.substring(0, 3)}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-2">
                `;

                // Jours vides au d√©but
                for (let i = 0; i < startingDayOfWeek; i++) {
                    html += '<div class="aspect-square"></div>';
                }

                // Jours du mois
                for (let day = 1; day <= daysInMonth; day++) {
                    const key = `${month}-${day}`;
                    const dayCelebrations = celebrationsByDate[key] || [];
                    const isToday = new Date().getDate() === day && 
                                   new Date().getMonth() === month && 
                                   new Date().getFullYear() === year;
                    
                    html += `
                        <div class="aspect-square bg-bg-dark rounded-lg p-2 border-2 ${isToday ? 'border-primary' : 'border-transparent'} hover:border-primary transition">
                            <div class="font-semibold ${isToday ? 'text-primary' : 'text-white'} mb-1">${day}</div>
                            <div class="space-y-1 overflow-y-auto max-h-20">
                                ${dayCelebrations.map(celeb => {
                                    const userId = allUsers.find(u => u.email && u.email.split('@')[0] === celeb.fileNumber)?.id;
                                    return `
                                        <div class="text-xs bg-primary bg-opacity-20 rounded px-1 py-0.5 cursor-pointer hover:bg-opacity-30 transition truncate" 
                                             onclick="event.stopPropagation(); showProfileModal('${userId || ''}', '${celeb.fullName || 'N/A'}', '${celeb.birthday || ''}', '${celeb.email || ''}')"
                                             title="${celeb.fullName || 'N/A'}">
                                            ${(celeb.fullName || 'N/A').substring(0, 8)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                calendarContainer.innerHTML = html;

            } else if (currentCalendarView === 'week') {
                // Vue hebdomadaire
                const weekStart = new Date(currentCalendarDate);
                weekStart.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
                
                let html = '<div class="grid grid-cols-7 gap-4">';
                
                for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(weekStart);
                    currentDay.setDate(weekStart.getDate() + i);
                    const day = currentDay.getDate();
                    const month = currentDay.getMonth();
                    const key = `${month}-${day}`;
                    const dayCelebrations = celebrationsByDate[key] || [];
                    const isToday = currentDay.toDateString() === new Date().toDateString();
                    
                    html += `
                        <div class="bg-bg-dark rounded-lg p-4 border-2 ${isToday ? 'border-primary' : 'border-transparent'}">
                            <div class="font-bold text-lg mb-2 ${isToday ? 'text-primary' : 'text-white'}">
                                ${dayNames[currentDay.getDay()]}
                            </div>
                            <div class="text-sm text-gray-400 mb-3">${day} ${monthNames[month]}</div>
                            <div class="space-y-2">
                                ${dayCelebrations.map(celeb => {
                        const userId = allUsers.find(u => u.email && u.email.split('@')[0] === celeb.fileNumber)?.id;
                                    return `
                                        <div class="bg-primary bg-opacity-20 rounded p-2 cursor-pointer hover:bg-opacity-30 transition" 
                                             onclick="showProfileModal('${userId || ''}', '${celeb.fullName || 'N/A'}', '${celeb.birthday || ''}', '${celeb.email || ''}')">
                                            <div class="font-semibold text-sm">${celeb.fullName || 'N/A'}</div>
                                            <div class="text-xs text-gray-400">${celeb.age} ans</div>
                            </div>
                        `;
                                }).join('')}
                                ${dayCelebrations.length === 0 ? '<p class="text-gray-500 text-xs">Aucun anniversaire</p>' : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                calendarContainer.innerHTML = html;

            } else if (currentCalendarView === 'year') {
                // Vue annuelle - tous les mois
                const year = currentCalendarDate.getFullYear();
                let html = '<div class="grid grid-cols-3 gap-4">';
                
                for (let month = 0; month < 12; month++) {
                    const monthCelebrations = [];
                    for (let day = 1; day <= 31; day++) {
                        const key = `${month}-${day}`;
                        if (celebrationsByDate[key]) {
                            monthCelebrations.push(...celebrationsByDate[key]);
                        }
                    }
                    monthCelebrations.sort((a, b) => a.day - b.day);
                    
                    html += `
                        <div class="bg-bg-dark rounded-lg p-4">
                            <h3 class="font-bold text-lg mb-3 text-primary">${monthNames[month]}</h3>
                            <div class="space-y-2">
                                ${monthCelebrations.length === 0 
                                    ? '<p class="text-gray-500 text-sm">Aucun anniversaire</p>'
                                    : monthCelebrations.map(celeb => {
                                        const userId = allUsers.find(u => u.email && u.email.split('@')[0] === celeb.fileNumber)?.id;
                                        const formattedDate = `${celeb.day}/${month + 1}`;
                                        return `
                                            <div class="bg-primary bg-opacity-20 rounded p-2 cursor-pointer hover:bg-opacity-30 transition" 
                                                 onclick="showProfileModal('${userId || ''}', '${celeb.fullName || 'N/A'}', '${celeb.birthday || ''}', '${celeb.email || ''}')">
                                                <div class="font-semibold text-sm">${celeb.fullName || 'N/A'}</div>
                                                <div class="text-xs text-gray-400">${formattedDate} ‚Ä¢ ${celeb.age} ans</div>
                                            </div>
                                        `;
                                    }).join('')
                                }
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                calendarContainer.innerHTML = html;
            }
            
            lucide.createIcons();
        }

        // Basculer entre les vues
        function showView(view) {
            const viewCalendrier = document.getElementById('viewCalendrier');
            const viewNotifications = document.getElementById('viewNotifications');
            const viewDefis = document.getElementById('viewDefis');
            const viewSettings = document.getElementById('viewSettings');
            const btnCalendrier = document.getElementById('btnCalendrier');
            const btnNotifications = document.getElementById('btnNotifications');
            const btnDefis = document.getElementById('btnDefis');
            const btnSettings = document.getElementById('btnSettings');

            // Cacher toutes les vues
            viewCalendrier.classList.add('hidden');
            if (viewDefis) viewDefis.classList.add('hidden');
            viewNotifications.classList.add('hidden');
            if (viewSettings) viewSettings.classList.add('hidden');
            
            // Retirer l'√©tat actif de tous les boutons
            btnCalendrier.classList.remove('active');
            btnNotifications.classList.remove('active');
            if (btnDefis) btnDefis.classList.remove('active');
            if (btnSettings) btnSettings.classList.remove('active');

            if (view === 'calendrier') {
                viewCalendrier.classList.remove('hidden');
                btnCalendrier.classList.add('active');
                pageTitle.textContent = 'Calendrier des Anniversaires';
                if (!currentCalendarView) {
                    currentCalendarView = 'month';
                }
                loadCalendarView();
            } else if (view === 'notifications') {
                viewNotifications.classList.remove('hidden');
                btnNotifications.classList.add('active');
                pageTitle.textContent = 'Mes Messages';
                loadNotificationsView();
            } else if (view === 'defis' && viewDefis) {
                viewDefis.classList.remove('hidden');
                if (btnDefis) btnDefis.classList.add('active');
                pageTitle.textContent = 'D√©fis';
                showDefisTab('progression');
            } else if (view === 'settings' && viewSettings) {
                viewSettings.classList.remove('hidden');
                if (btnSettings) btnSettings.classList.add('active');
                pageTitle.textContent = 'Param√®tres';
                loadMyProfileContent();
                loadProfilePhoto();
                // Initialiser l'onglet par d√©faut (Mon Profil)
                switchSettingsTab('profile');
            }
            
            lucide.createIcons();
        }

        // Basculer entre les onglets Settings
        window.switchSettingsTab = function(tabName) {
            // Cacher toutes les sections
            const sections = ['profile', 'wishlist', 'preferences'];
            sections.forEach(section => {
                const sectionEl = document.getElementById(`settingsSection${section.charAt(0).toUpperCase() + section.slice(1)}`);
                if (sectionEl) {
                    sectionEl.classList.add('hidden');
                }
            });

            // Retirer l'√©tat actif de tous les boutons
            const buttons = ['Profile', 'Wishlist', 'Preferences'];
            buttons.forEach(btn => {
                const btnEl = document.getElementById(`settingsTab${btn}`);
                if (btnEl) {
                    btnEl.classList.remove('active');
                    btnEl.classList.remove('border-primary');
                    btnEl.classList.remove('text-primary');
                }
            });

            // Afficher la section s√©lectionn√©e
            const sectionEl = document.getElementById(`settingsSection${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (sectionEl) {
                sectionEl.classList.remove('hidden');
            }

            // Activer le bouton correspondant
            const btnName = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const btnEl = document.getElementById(`settingsTab${btnName}`);
            if (btnEl) {
                btnEl.classList.add('active');
                btnEl.classList.add('border-primary');
                btnEl.classList.add('text-primary');
            }

            // Charger les donn√©es si n√©cessaire
            if (tabName === 'wishlist') {
                loadSettingsWishlist();
            }
        };

        // Calculer les jours jusqu'√† l'anniversaire
        function daysUntilBirthday(birthday) {
            if (!birthday) return null;
            const dateParts = birthday.split('-');
            if (dateParts.length !== 3) return null;
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const birthMonth = parseInt(dateParts[1]) - 1;
            const birthDay = parseInt(dateParts[2]);
            
            // Date d'anniversaire cette ann√©e
            let birthdayThisYear = new Date(currentYear, birthMonth, birthDay);
            
            // Si l'anniversaire est d√©j√† pass√© cette ann√©e, prendre l'ann√©e prochaine
            if (birthdayThisYear < today) {
                birthdayThisYear = new Date(currentYear + 1, birthMonth, birthDay);
            }
            
            const diffTime = birthdayThisYear - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Charger les anniversaires √† venir (dans 1 semaine ou moins)
        async function loadUpcomingBirthdays() {
            const upcomingBirthdaysDiv = document.getElementById('upcomingBirthdays');
            const sendMessageSection = document.getElementById('sendMessageSection');
            
            if (!allCelebrations.length) {
                sendMessageSection.classList.add('hidden');
                return;
            }

            const upcoming = [];
            allCelebrations.forEach(celeb => {
                if (!celeb.birthday) return;
                const days = daysUntilBirthday(celeb.birthday);
                if (days !== null && days >= 0 && days <= 7) {
                    upcoming.push({ ...celeb, daysUntil: days });
                }
            });

            if (upcoming.length === 0) {
                sendMessageSection.classList.add('hidden');
                return;
            }

            sendMessageSection.classList.remove('hidden');
            upcomingBirthdaysDiv.innerHTML = '';

            // V√©rifier pour chaque personne si un message a d√©j√† √©t√© envoy√©
            for (const person of upcoming) {
                let messageAlreadySent = false;
                
                if (currentUserId) {
                    const existingMessage = await firebase.firestore().collection('messages')
                        .where('senderId', '==', currentUserId)
                        .where('celebrationId', '==', person.id)
                        .limit(1)
                        .get();
                    
                    messageAlreadySent = !existingMessage.empty;
                }

                const card = document.createElement('div');
                card.className = 'message-card p-5 rounded-xl mb-4';
                
                const dateParts = person.birthday.split('-');
                const formattedDate = `${dateParts[2]}/${dateParts[1]}`;
                const daysText = person.daysUntil === 0 ? "Aujourd'hui ! üéâ" : 
                                person.daysUntil === 1 ? "Demain ! üéÇ" : 
                                `Dans ${person.daysUntil} jours`;

                const buttonDisabled = messageAlreadySent ? 'disabled opacity-50 cursor-not-allowed' : '';
                const buttonText = messageAlreadySent ? 'D√©j√† envoy√© ‚úì' : 'Envoyer';
                const textareaDisabled = messageAlreadySent ? 'disabled opacity-50 cursor-not-allowed' : '';
                const textareaPlaceholder = messageAlreadySent ? 'Vous avez d√©j√† envoy√© un message √† cette personne.' : '√âcris un message personnalis√© pour souhaiter un joyeux anniversaire... üéâ';

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-xl">
                                üéÇ
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">${person.fullName || 'N/A'}</h4>
                                <p class="text-sm text-gray-400">${formattedDate} ‚Ä¢ <span class="text-primary font-semibold">${daysText}</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-300">Ton message</label>
                                ${!messageAlreadySent ? `
                                    <button onclick="generateBirthdayMessage('${person.id}')" class="flex items-center px-3 py-1.5 rounded-lg bg-secondary hover:bg-opacity-90 text-bg-dark text-xs font-semibold transition">
                                        <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i>
                                        G√©n√©rer un message
                                    </button>
                                ` : ''}
                            </div>
                            <textarea id="message_${person.id}" ${messageAlreadySent ? 'disabled' : ''} class="w-full p-3 rounded-lg text-white text-sm resize-none ${textareaDisabled}" placeholder="${textareaPlaceholder}" rows="3"></textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center space-x-2 cursor-pointer group">
                                <input type="checkbox" id="public_${person.id}" ${messageAlreadySent ? 'disabled' : ''} class="w-4 h-4 rounded border-gray-600 bg-bg-dark text-primary focus:ring-primary focus:ring-2 ${messageAlreadySent ? 'opacity-50 cursor-not-allowed' : ''}">
                                <span class="text-sm text-gray-300 group-hover:text-white transition">Message public (visible par tous)</span>
                            </label>
                            <button onclick="${messageAlreadySent ? '' : `sendMessage('${person.id}', '${person.fullName}')`}" ${messageAlreadySent ? 'disabled' : ''} class="send-button px-6 py-2 rounded-lg text-white text-sm font-semibold flex items-center space-x-2 ${buttonDisabled}">
                                <i data-lucide="${messageAlreadySent ? 'check' : 'send'}" class="w-4 h-4"></i>
                                <span>${buttonText}</span>
                            </button>
                        </div>
                    </div>
                `;
                upcomingBirthdaysDiv.appendChild(card);
            }

            lucide.createIcons();
        }

        // Envoyer un message
        async function sendMessage(celebrationId, recipientName) {
            const messageText = document.getElementById(`message_${celebrationId}`).value.trim();
            const isPublic = document.getElementById(`public_${celebrationId}`).checked;

            if (!messageText) {
                alert('Veuillez √©crire un message !');
                return;
            }

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            // V√©rifier le statut et la r√©putation de l'utilisateur
            const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
            const userData = userDoc.data();
            const userStatus = userData.status || 'active';
            const userReputation = userData.reputation || 100;

            // V√©rifier si l'utilisateur est bloqu√© ou spectateur
            if (userStatus === 'blocked' || userStatus === 'spectator') {
                alert(`‚ö†Ô∏è Vous ne pouvez pas envoyer de messages. Statut: ${userStatus === 'blocked' ? 'Bloqu√©' : 'Spectateur'}`);
                return;
            }

            // V√©rifier si la r√©putation est trop basse
            if (userReputation < 50) {
                alert(`‚ö†Ô∏è Votre r√©putation est trop faible (${userReputation}/100) pour envoyer des messages. Veuillez am√©liorer votre comportement.`);
                return;
            }

            // R√©cup√©rer l'ID utilisateur du destinataire (n√©cessaire pour l'enregistrement des messages bloqu√©s)
            const celebration = allCelebrations.find(c => c.id === celebrationId);
            if (!celebration || !celebration.fileNumber) {
                alert('Erreur : impossible de trouver le destinataire');
                return;
            }

            // Trouver l'utilisateur par fileNumber
            const recipientUsers = await firebase.firestore().collection('users')
                .where('email', '==', `${celebration.fileNumber}@cslaval.qc.ca`)
                .limit(1)
                .get();

            if (recipientUsers.empty) {
                alert('Erreur : utilisateur destinataire non trouv√©');
                return;
            }

            const recipientId = recipientUsers.docs[0].id;
            const senderData = await firebase.firestore().collection('users').doc(currentUserId).get();
            const senderName = senderData.data()?.fullName || 'Anonyme';

            // Valider le message (v√©rifier les mots interdits)
            const validation = validateMessage(messageText);
            if (!validation.valid) {
                // D√©cr√©menter la r√©putation
                const newReputation = Math.max(0, userReputation - 5);
                await firebase.firestore().collection('users').doc(currentUserId).update({
                    reputation: newReputation
                });

                // Enregistrer le message bloqu√© dans Firestore
                try {
                    await firebase.firestore().collection('blockedMessages').add({
                        userId: currentUserId,
                        userName: senderName,
                        message: messageText,
                        recipientId: recipientId,
                        recipientName: recipientName,
                        celebrationId: celebrationId,
                        reputationBefore: userReputation,
                        reputationAfter: newReputation,
                        blockedWord: validation.word || 'inconnu',
                        reason: validation.reason,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erreur lors de l\'enregistrement du message bloqu√©:', error);
                }

                // Si la r√©putation tombe en dessous de 50, bloquer les messages
                if (newReputation < 50) {
                    await firebase.firestore().collection('users').doc(currentUserId).update({
                        status: 'blocked'
                    });
                    alert(`‚ö†Ô∏è ${validation.reason}\n\nVotre r√©putation a √©t√© r√©duite √† ${newReputation}/100. Vous ne pouvez plus envoyer de messages jusqu'√† ce que votre r√©putation s'am√©liore.`);
                } else {
                    alert(`‚ö†Ô∏è ${validation.reason}\n\nVotre r√©putation a √©t√© r√©duite √† ${newReputation}/100. Veuillez modifier votre message avant de l'envoyer.`);
                }
                
                // Mettre en √©vidence le textarea avec une bordure rouge
                const textarea = document.getElementById(`message_${celebrationId}`);
                textarea.style.borderColor = '#ef4444';
                textarea.style.borderWidth = '2px';
                textarea.focus();
                
                // Retirer la bordure rouge apr√®s 3 secondes
                setTimeout(() => {
                    textarea.style.borderColor = '';
                    textarea.style.borderWidth = '';
                }, 3000);
                
                return;
            }

            // Les informations du destinataire et de l'exp√©diteur sont d√©j√† r√©cup√©r√©es plus haut
            const recipientData = recipientUsers.docs[0].data();
            const recipientEmail = recipientData.email;

            // V√©rifier si l'utilisateur a d√©j√† envoy√© un message √† cette personne
            const existingMessage = await firebase.firestore().collection('messages')
                .where('senderId', '==', currentUserId)
                .where('celebrationId', '==', celebrationId)
                .limit(1)
                .get();

            if (!existingMessage.empty) {
                alert('‚ö†Ô∏è Vous avez d√©j√† envoy√© un message √† cette personne. Vous ne pouvez envoyer qu\'un seul message par personne.');
                return;
            }

            try {
                await firebase.firestore().collection('messages').add({
                    recipientId: recipientId,
                    senderId: currentUserId,
                    senderName: senderName,
                    recipientName: recipientName,
                    message: messageText,
                    isPublic: isPublic,
                    celebrationId: celebrationId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                // Envoyer une notification par email
                // Adapter le message selon le contexte (anniversaire ou message g√©n√©ral)
                let birthdayMessage = '';
                if (celebration && celebration.birthday) {
                    const days = daysUntilBirthday(celebration.birthday);
                    if (days !== null && days >= 0 && days <= 7) {
                        birthdayMessage = days === 0 ? "C'est ton anniversaire aujourd'hui ! üéâ" : 
                                         days === 1 ? "C'est ton anniversaire demain ! üéÇ" : 
                                         `Ton anniversaire est dans ${days} jours !`;
                    }
                }
                
                // Envoyer la notification par email (fonctionne pour tous les r√¥les)
                await sendMessageNotification(
                    recipientEmail,
                    recipientName,
                    senderName,
                    messageText,
                    isPublic,
                    birthdayMessage || 'Tu as re√ßu un nouveau message !'
                );

                // Mettre √† jour les statistiques
                if (!statsSystem) {
                    statsSystem = new StatsSystem(currentUserId);
                }
                await statsSystem.incrementMessagesSent();
                await statsSystem.addPoints(5); // 5 points par message envoy√©
                
                // Mettre √† jour les stats du destinataire (messages re√ßus)
                const recipientStatsSystem = new StatsSystem(recipientUserId);
                await recipientStatsSystem.incrementMessagesReceived();

                // R√©initialiser le formulaire
                document.getElementById(`message_${celebrationId}`).value = '';
                document.getElementById(`public_${celebrationId}`).checked = false;

                alert('Message envoy√© avec succ√®s ! üéâ');
                
                // V√©rifier la progression des 9 personnes cons√©cutives
                try {
                    // Charger le script de progression si pas d√©j√† charg√©
                    if (typeof checkAndNotify9Consecutive === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'js/progression-system.js';
                        document.head.appendChild(script);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    await checkAndNotify9Consecutive();
                } catch (error) {
                    console.error('Erreur lors de la v√©rification de progression:', error);
                }
                
                // Recharger les anniversaires √† venir pour mettre √† jour l'√©tat des boutons
                await loadUpcomingBirthdays();
                loadNotifications();
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message:', error);
                alert('Erreur lors de l\'envoi du message');
            }
        }

        // Charger les notifications
        async function loadNotifications() {
            if (!currentUserId) return;

            try {
                const messagesSnapshot = await firebase.firestore().collection('messages')
                    .where('recipientId', '==', currentUserId)
                    .get();

                // Trier c√¥t√© client pour √©viter le besoin d'index composite
                const messages = messagesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                const unreadCount = messages.filter(msg => !msg.read).length;
                
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des notifications:', error);
            }
        }

        // Charger la vue notifications
        async function loadNotificationsView() {
            const messagesList = document.getElementById('messagesList');
            const birthdayExplanation = document.getElementById('birthdayExplanation');
            const sendMessageSection = document.getElementById('sendMessageSection');

            // V√©rifier si l'anniversaire de l'utilisateur approche
            if (currentUserBirthday) {
                const days = daysUntilBirthday(currentUserBirthday);
                if (days !== null && days >= 0 && days <= 7) {
                    birthdayExplanation.classList.remove('hidden');
                } else {
                    birthdayExplanation.classList.add('hidden');
                }
            }

            // Charger les anniversaires √† venir pour envoyer des messages
            loadUpcomingBirthdays();

            // Charger les messages re√ßus
            if (!currentUserId) {
                messagesList.innerHTML = '<p class="text-gray-500 text-center py-8">Erreur : utilisateur non connect√©</p>';
                return;
            }

            try {
                const messagesSnapshot = await firebase.firestore().collection('messages')
                    .where('recipientId', '==', currentUserId)
                    .get();

                if (messagesSnapshot.empty) {
                    messagesList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun message re√ßu pour le moment.</p>';
                    return;
                }

                // Trier c√¥t√© client pour √©viter le besoin d'index composite
                const messages = messagesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                messagesList.innerHTML = '';
                
                // Charger toutes les photos de profil des exp√©diteurs
                const senderPhotosMap = new Map();
                const uniqueSenderIds = [...new Set(messages.map(m => m.senderId).filter(Boolean))];
                for (const senderId of uniqueSenderIds) {
                    const photoUrl = await getUserProfilePhoto(senderId);
                    if (photoUrl) {
                        senderPhotosMap.set(senderId, photoUrl);
                    }
                }
                
                messages.forEach(messageData => {
                    const message = messageData;
                    const messageCard = document.createElement('div');
                    messageCard.className = `message-card p-5 rounded-xl mb-4 ${!message.read ? 'border-l-4 border-primary ring-2 ring-primary ring-opacity-50' : 'opacity-90'}`;
                    
                    const date = message.createdAt?.toDate ? message.createdAt.toDate() : new Date();
                    const formattedDate = date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const senderPhotoUrl = message.senderId ? senderPhotosMap.get(message.senderId) : null;

                    messageCard.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-3">
                                    ${senderPhotoUrl ? `
                                        <img src="${senderPhotoUrl}" alt="${message.senderName || 'Anonyme'}" class="w-10 h-10 rounded-full object-cover border-2 border-primary">
                                    ` : `
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-lg font-bold">
                                            ${(message.senderName || 'A')[0].toUpperCase()}
                                        </div>
                                    `}
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="font-bold text-lg">${message.senderName || 'Anonyme'}</span>
                                            ${message.isPublic ? 
                                                '<span class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full font-semibold">Public</span>' : 
                                                '<span class="text-xs bg-purple-500 text-white px-3 py-1 rounded-full font-semibold">Secret</span>'
                                            }
                                            ${!message.read ? '<span class="text-xs bg-primary text-white px-2 py-1 rounded-full animate-pulse">Nouveau</span>' : ''}
                                        </div>
                                        <p class="text-xs text-gray-400">${formattedDate}</p>
                                    </div>
                                </div>
                                <div class="bg-bg-dark p-4 rounded-lg border border-gray-700">
                                    <p class="text-gray-200 leading-relaxed">${message.message}</p>
                                </div>
                            </div>
                            ${!message.read ? `
                                <button onclick="markAsRead('${message.id}')" class="ml-4 p-2 rounded-lg bg-primary hover:bg-secondary text-white transition transform hover:scale-110" title="Marquer comme lu">
                                    <i data-lucide="check" class="w-5 h-5"></i>
                                </button>
                            ` : `
                                <div class="ml-4 p-2 rounded-lg bg-gray-700 text-gray-400">
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                </div>
                            `}
                        </div>
                    `;
                    messagesList.appendChild(messageCard);
                });

                lucide.createIcons();
                loadNotifications(); // Mettre √† jour le badge
            } catch (error) {
                console.error('Erreur lors du chargement des messages:', error);
                messagesList.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement des messages.</p>';
            }
        }


        // Charger la vue des profils (autres √©l√®ves)
        async function loadProfilesView() {
            const profilesContent = document.getElementById('profilesContent');
            const otherProfilesSection = document.getElementById('otherProfilesSection');
            const profilesSeparator = document.getElementById('profilesSeparator');
            
            profilesContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement...</p>';

            try {
                // V√©rifier si la visibilit√© est activ√©e
                const settingsDoc = await firebase.firestore().collection('settings').doc('profileVisibility').get();
                const enabled = settingsDoc.exists && settingsDoc.data().enabled || false;

                if (!enabled) {
                    profilesContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="lock" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                            <p class="text-gray-400">La visibilit√© des profils n'est pas activ√©e pour le moment.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Charger tous les √©l√®ves
                const users = await getAllUsers();
                const students = users.filter(u => u.role === 'eleve' && (u.id !== currentUserId && u.uid !== currentUserId));

                if (students.length === 0) {
                    profilesContent.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun autre √©l√®ve trouv√©.</p>';
                    return;
                }

                // Filtrer seulement ceux qui ont compl√©t√© leur profil
                const studentsWithProfiles = students.filter(s => s.profileCompleted);

                if (studentsWithProfiles.length === 0) {
                    profilesContent.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun √©l√®ve n\'a encore compl√©t√© son profil.</p>';
                    return;
                }

                // Afficher la liste
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                studentsWithProfiles.forEach(student => {
                    const studentId = student.id || student.uid; // Utiliser id (document ID) ou uid en fallback
                    html += `
                        <div class="card p-4 rounded-xl hover:shadow-lg transition cursor-pointer" onclick="viewStudentProfile('${studentId}')">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold text-lg">
                                    ${(student.fullName || '?')[0].toUpperCase()}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg">${student.fullName || 'N/A'}</h3>
                                    <p class="text-sm text-gray-400">${student.email || ''}</p>
                                </div>
                            </div>
                            <button class="w-full mt-3 px-4 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                Voir le profil
                            </button>
                        </div>
                    `;
                });
                html += '</div>';

                profilesContent.innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement des profils:', error);
                profilesContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement des profils.</p>';
            }
        }

        // Voir le profil d'un √©l√®ve
        window.viewStudentProfile = function(studentId) {
            window.location.href = `student-profile.html?id=${studentId}`;
        }

        // Basculer entre les onglets Settings

        // Charger le contenu du profil de l'utilisateur
        async function loadMyProfileContent() {
            const myProfileContent = document.getElementById('myProfileContent');
            if (!currentUserId) {
                myProfileContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur : utilisateur non connect√©</p>';
                return;
            }

            myProfileContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement...</p>';

            try {
                const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
                if (!userDoc.exists) {
                    myProfileContent.innerHTML = '<p class="text-red-400 text-center py-8">Utilisateur non trouv√©</p>';
                    return;
                }

                const userData = userDoc.data();
                if (!userData.profileCompleted || !userData.profileInfo) {
                    myProfileContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="user-x" class="w-16 h-16 mx-auto mb-4 text-gray-500"></i>
                            <p class="text-gray-400 mb-4">Ton profil n'est pas encore compl√©t√©.</p>
                            <button onclick="openEditProfileModal()" class="px-4 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                Compl√©ter mon profil
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                let html = `
                    <div class="bg-bg-dark p-6 rounded-lg border border-gray-700 mb-4">
                        <div class="flex items-center space-x-4 mb-6">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold text-2xl">
                                ${(userData.fullName || '?')[0].toUpperCase()}
                            </div>
                            <div>
                                <h3 class="font-bold text-xl">${userData.fullName || 'N/A'}</h3>
                                <p class="text-sm text-gray-400">${userData.email || ''}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                `;

                // Afficher les informations du profil
                for (const [key, value] of Object.entries(userData.profileInfo)) {
                    // Les valeurs sont stock√©es comme des objets avec {answer, isPublic, questionNumber, encrypted?}
                    let answer = '';
                    let isPublic = false;
                    let isEncrypted = false;
                    
                    if (typeof value === 'object' && value !== null) {
                        answer = value.answer || '';
                        isPublic = value.isPublic || false;
                        isEncrypted = value.encrypted || false;
                    } else if (typeof value === 'string') {
                        // Ancien format (string directe) - pour compatibilit√©
                        answer = value;
                    }
                    
                    // D√©crypter le crush secret si n√©cessaire
                    if (key === 'crushSecret' && isEncrypted && answer) {
                        try {
                            answer = decryptCrushSecret(answer, currentUserId);
                        } catch (e) {
                            answer = '***';
                        }
                    }
                    
                    // Ne pas afficher si la r√©ponse est vide
                    if (!answer || answer.trim() === '') {
                        continue;
                    }
                    
                    html += `
                        <div class="border-b border-gray-700 pb-3">
                            <div class="flex items-center justify-between mb-1">
                                <p class="text-sm text-gray-400">${questionLabels[key] || key}</p>
                                ${isPublic ? '<span class="text-xs bg-green-500 bg-opacity-30 text-green-300 px-2 py-1 rounded">Public</span>' : '<span class="text-xs bg-red-500 bg-opacity-30 text-red-300 px-2 py-1 rounded">Priv√©</span>'}
                            </div>
                            <p class="text-white font-semibold">${answer}</p>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;

                myProfileContent.innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
                myProfileContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement du profil.</p>';
            }
        }

        // Liste des mots interdits (filtre de contenu) - Plus de 200 mots
        const forbiddenWords = [
            // Mots vulgaires classiques
            'merde', 'putain', 'con', 'connard', 'conne', 'connasse', 'connasses', 'salope', 'salopes', 'salopard',
            'encul√©', 'enculer', 'encul√©e', 'encul√©es', 'encul√©s', 'bite', 'chier', 'chi√©', 'chiant', 'chiasse',
            'bordel', 'foutre', 'fout', 'foutue', 'foutu', 'foutus', 'foutues', 'pute', 'putes', 'p√©d√©',
            'p√©dale', 'p√©dales', 'tapette', 'tapettes', 'tarlouze', 'tarlouzes', 'p√©dophile', 'p√©dophiles',
            'nique', 'niquer', 'niquez', 'niquent', 'niqu√©', 'niqu√©e', 'niqu√©s', 'niqu√©es', 'niques',
            'salaud', 'salauds', 'salaude', 'salaudes', 'cr√©tin', 'cr√©tine', 'cr√©tins', 'cr√©tines',
            'idiot', 'idiote', 'idiots', 'idiotes', 'd√©bile', 'd√©biles', 'd√©bilit√©', 'imb√©cile', 'imb√©ciles',
            'abruti', 'abrutie', 'abrutis', 'abruties',
            
            // Mots offensants et expressions
            'fdp', 'pd', 'tg', 'tagueule', 'ta gueule', 'ferme ta gueule', 'ferme-la', 'ferme la',
            'va te faire', 'va te faire foutre', 'va te faire enculer', 'va te faire voir', 'va chier',
            'va niquer', 'va te faire niquer', 'casse-toi', 'cassez-vous', 'd√©gage', 'd√©gagez', 'd√©gageons',
            'd√©gag√©', 'd√©gag√©e', 'd√©gag√©s', 'd√©gag√©es', 'barre-toi', 'barrez-vous', 'fous le camp',
            'fous-moi le camp', 'foutez le camp', 'foutez-moi le camp',
            
            // Insultes et termes d√©gradants
            'sous-merde', 'sous-merdes', 'fils de pute', 'fils de putes', 'fille de pute', 'filles de pute',
            'filsdepute', 'filsdeputes', 'fillesdepute', 'fillesdeputes', 'garce', 'garces', 'ordure',
            'ordures', 'racaille', 'railles', 'voyou', 'voyous', 'voyoute', 'voyoutes', 'bandit', 'bandits',
            'bandite', 'bandites', 'criminel', 'criminelle', 'criminels', 'criminelles', 'voleur', 'voleuse',
            'voleurs', 'voleuses',
            
            // Mots modernes/slang offensants
            'ptn', 'nique ta m√®re', 'nique sa m√®re', 'niquez vos m√®res', 'nique ta race', 'nique sa race',
            'niquez vos races', 'nique ta famille', 'nique sa famille', 'niquez vos familles', 'nique ton p√®re',
            'nique son p√®re', 'niquez vos p√®res',
            
            // Termes grossiers
            'baiser', 'bais√©', 'bais√©e', 'bais√©s', 'bais√©es', 'baise', 'baises', 'baisez', 'baisent',
            'baiser', 'cul', 'culs', 'fion', 'fions', 'chatte', 'chattes', 'bite', 'bites', 'zizi',
            'zizis', 'zob', 'zobs', 'queue', 'queues', 'couilles', 'couille', 'couilles', 'testicules',
            'testicule', 'testicules', 'seins', 'sein', 'seins', 'nichons', 'nichon', 'nichons', 't√©tons',
            't√©ton', 't√©tons', 't√©tasses', 't√©tasse', 't√©tasses',
            
            // Insultes racistes et discriminatoires
            'n√®gre', 'n√©gre', 'n√©gresse', 'n√©gres', 'n√©gresses', 'youpin', 'youpine', 'youpins', 'youpines',
            'bougnoule', 'bougnoules', 'bicot', 'bicots', 'bicotte', 'bicottes', 'raton', 'ratons', 'ratonne',
            'ratonnes', 'sale arabe', 'sale noir', 'sale juif', 'sale musulman', 'sale chinois', 'sale asiatique',
            'bougnoul', 'bougnouls', 'bougnoule', 'bougnoules', 'bamboula', 'bamboulas', 'bicot', 'bicots',
            
            // Termes homophobes
            'gouine', 'gouines', 'p√©d√©raste', 'p√©d√©rastes', 'sodomite', 'sodomites', 'tapette', 'tapettes',
            'tarlouze', 'tarlouzes', 'p√©dale', 'p√©dales', 'p√©d√©', 'p√©d√©s',
            
            // Termes sexistes
            'p√©tasse', 'p√©tasses', 'chienne', 'chiennes', 'garce', 'garces', 'connasse', 'connasses',
            'salope', 'salopes', 'pute', 'putes', 'pouffiasse', 'pouffiasses', 'pouffe', 'pouffes',
            'pouffiasse', 'pouffiasses', 'garce', 'garces',
            
            // Mots vulgaires suppl√©mentaires
            'branlette', 'branlettes', 'branler', 'branl√©', 'branl√©e', 'branl√©s', 'branl√©es', 'branle',
            'branles', 'branlez', 'branlent', 'masturber', 'masturb√©', 'masturb√©e', 'masturb√©s', 'masturb√©es',
            'masturbe', 'masturbes', 'masturbez', 'masturbent', 'se branler', 'se masturber', 'branlette',
            'branlettes', 'pomper', 'pomp√©', 'pomp√©e', 'pomp√©s', 'pomp√©es', 'pompe', 'pompes', 'pompez',
            'pompent', 'sucer', 'suc√©', 'suc√©e', 'suc√©s', 'suc√©es', 'suce', 'suces', 'sucez', 'sucent',
            
            // Termes offensants suppl√©mentaires
            'tar√©', 'tar√©e', 'tar√©s', 'tar√©es', 'cingl√©', 'cingl√©e', 'cingl√©s', 'cingl√©es', 'dingue',
            'dingues', 'dingo', 'dingos', 'fou', 'fous', 'folle', 'folles', 'd√©jant√©', 'd√©jant√©e', 'd√©jant√©s',
            'd√©jant√©es', 'malade', 'malades', 'malade mental', 'malades mentaux', 'malade mentale',
            'malades mentales', 'd√©bile mental', 'd√©biles mentaux', 'd√©bile mentale', 'd√©biles mentales',
            
            // Mots offensants modernes (slang)
            'kikoo', 'kikou', 'tg', 'tagueule', 'ta gueule', 'fdp', 'pd', 'ptn', 'ptdr', 'mdr', 'lol',
            'nique', 'niquer', 'niquez', 'niquent', 'niqu√©', 'niqu√©e', 'niqu√©s', 'niqu√©es', 'niques',
            'nique ta m√®re', 'nique sa m√®re', 'niquez vos m√®res', 'nique ta race', 'nique sa race',
            'niquez vos races', 'nique ta famille', 'nique sa famille', 'niquez vos familles',
            
            // Termes violents
            'tuer', 'tu√©', 'tu√©e', 'tu√©s', 'tu√©es', 'tue', 'tues', 'tuez', 'tuent', 'assassiner',
            'assassin√©', 'assassin√©e', 'assassin√©s', 'assassin√©es', 'assassine', 'assassines', 'assassinez',
            'assassinent', 'massacrer', 'massacr√©', 'massacr√©e', 'massacr√©s', 'massacr√©es', 'massacre',
            'massacres', 'massacrez', 'massacrent', '√©gorger', '√©gorg√©', '√©gorg√©e', '√©gorg√©s', '√©gorg√©es',
            '√©gorge', '√©gorges', '√©gorgez', '√©gorgent', 'poignarder', 'poignard√©', 'poignard√©e', 'poignard√©s',
            'poignard√©es', 'poignarde', 'poignardes', 'poignardez', 'poignardent',
            
            // Mots offensants additionnels
            'minable', 'minables', 'nul', 'nulle', 'nuls', 'nulles', 'pourri', 'pourrie', 'pourris',
            'pourries', 'd√©gueulasse', 'd√©gueulasses', 'd√©gueulasse', 'd√©goutant', 'd√©goutante', 'd√©goutants',
            'd√©goutantes', 'd√©go√ªtant', 'd√©go√ªtante', 'd√©go√ªtants', 'd√©go√ªtantes', 'infect', 'infecte',
            'infects', 'infectes', 'immonde', 'immondes', 'ignoble', 'ignobles', 'vile', 'viles', 'bas',
            'basse', 'basses', 'basses', 'm√©prisable', 'm√©prisables', 'honteux', 'honteuse', 'honteux',
            'honteuses', 'l√¢che', 'l√¢ches', 'l√¢che', 'l√¢ches', 'tra√Ætre', 'tra√Ætres', 'tra√Ætresse',
            'tra√Ætresses', 'sale', 'sales', 'sale', 'sales', 'crasseux', 'crasseuse', 'crasseux', 'crasseuses',
            
            // Termes d√©gradants suppl√©mentaires
            'sous-merde', 'sous-merdes', 'sous-race', 'sous-races', 'sous-homme', 'sous-hommes', 'sous-femme',
            'sous-femmes', 'sous-√™tre', 'sous-√™tres', 'sous-humain', 'sous-humains', 'sous-humaine',
            'sous-humaines', 'sous-d√©velopp√©', 'sous-d√©velopp√©s', 'sous-d√©velopp√©e', 'sous-d√©velopp√©es',
            
            // Mots offensants finaux
            'merdeux', 'merdeuse', 'merdeux', 'merdeuses', 'merdique', 'merdiques', 'merdique', 'merdiques',
            'chi√©', 'chi√©e', 'chi√©s', 'chi√©es', 'chiant', 'chiante', 'chiants', 'chiantes', 'chiasse',
            'chiasses', 'chiasse', 'chiasses', 'bord√©lique', 'bord√©liques', 'bord√©lique', 'bord√©liques',
            'foutraque', 'foutraques', 'foutraque', 'foutraques', 'foutriquet', 'foutriquets', 'foutriquet',
            'foutriquets', 'foutriquet', 'foutriquets', 'foutriquet', 'foutriquets'
        ];

        // Fonction de validation des messages (v√©rification des mots interdits)
        function validateMessage(message) {
            if (!message || typeof message !== 'string') {
                return { valid: false, reason: 'Le message est vide ou invalide.' };
            }

            // Normaliser le message (minuscules, sans accents pour certains caract√®res)
            const normalizedMessage = message.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Enlever les accents
                .replace(/[^\w\s]/g, ' '); // Remplacer la ponctuation par des espaces

            // V√©rifier chaque mot interdit
            for (const word of forbiddenWords) {
                const normalizedWord = word.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
                
                // V√©rifier si le mot interdit est pr√©sent (mot complet, pas juste une partie)
                const regex = new RegExp(`\\b${normalizedWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                if (regex.test(normalizedMessage)) {
                    return { 
                        valid: false, 
                        reason: `Votre message contient un mot inappropri√©. Veuillez modifier votre message pour qu'il soit respectueux.`,
                        word: word
                    };
                }
            }

            return { valid: true };
        }

        // Messages de bonne f√™te al√©atoires
        const birthdayMessages = [
            "üéâ Joyeux anniversaire ! Que cette nouvelle ann√©e t'apporte plein de bonheur et de r√©ussite !",
            "üéÇ Bon anniversaire ! Profite bien de ta journ√©e sp√©ciale !",
            "üéà Joyeux anniversaire ! Que tous tes r√™ves se r√©alisent !",
            "üéÅ Bonne f√™te ! Passe une superbe journ√©e remplie de joie !",
            "üåü Joyeux anniversaire ! Que cette ann√©e soit la meilleure de toutes !",
            "üéä Bon anniversaire ! Que la chance te sourie toute l'ann√©e !",
            "üéâ Joyeux anniversaire ! Profite de chaque moment de cette journ√©e sp√©ciale !",
            "üéÇ Bonne f√™te ! Que cette nouvelle ann√©e soit remplie de moments magiques !",
            "üéà Joyeux anniversaire ! Que tous tes souhaits se r√©alisent !",
            "üéÅ Bon anniversaire ! Passe une journ√©e inoubliable !",
            "üåü Joyeux anniversaire ! Que cette ann√©e t'apporte plein de bonheur !",
            "üéä Bonne f√™te ! Que tous tes projets se r√©alisent !",
            "üéâ Joyeux anniversaire ! Que cette journ√©e soit remplie de surprises !",
            "üéÇ Bon anniversaire ! Profite bien de ta journ√©e sp√©ciale avec tes proches !",
            "üéà Joyeux anniversaire ! Que cette nouvelle ann√©e soit exceptionnelle !",
            "üéÅ Bonne f√™te ! Que tous tes r√™ves deviennent r√©alit√© !",
            "üåü Joyeux anniversaire ! Que cette ann√©e soit la plus belle !",
            "üéä Bon anniversaire ! Passe une journ√©e magique !",
            "üéâ Joyeux anniversaire ! Que cette journ√©e soit remplie de joie et de rires !",
            "üéÇ Bonne f√™te ! Que cette nouvelle ann√©e t'apporte plein de succ√®s !"
        ];

        // G√©n√©rer un message de bonne f√™te al√©atoire
        window.generateBirthdayMessage = function(celebrationId) {
            const messageTextarea = document.getElementById(`message_${celebrationId}`);
            if (!messageTextarea) return;

            // S√©lectionner un message al√©atoire
            const randomMessage = birthdayMessages[Math.floor(Math.random() * birthdayMessages.length)];
            
            // Remplir le textarea avec le message g√©n√©r√©
            messageTextarea.value = randomMessage;
            
            // Focus sur le textarea pour que l'utilisateur puisse modifier si besoin
            messageTextarea.focus();
            
            // Animation visuelle pour indiquer que le message a √©t√© g√©n√©r√©
            messageTextarea.style.transition = 'all 0.3s ease';
            messageTextarea.style.borderColor = 'var(--secondary)';
            setTimeout(() => {
                messageTextarea.style.borderColor = '';
            }, 1000);
        }

        // Mapping des questions (identique √† student-profile.html)
        const questionLabels = {
            crushSecret: 'Crush secret',
            meilleurAmi: 'Meilleur ami(e)',
            animalPrefere: 'Animal pr√©f√©r√©',
            platPrefere: 'Plat pr√©f√©r√©',
            sportPrefere: 'Sport pr√©f√©r√©',
            musiquePreferee: 'Groupe/artiste de musique pr√©f√©r√©',
            filmPrefere: 'Film pr√©f√©r√©',
            livrePrefere: 'Livre pr√©f√©r√©',
            passeTemps: 'Passe-temps favori',
            qualiteAdmiree: 'Qualit√© admir√©e',
            faitRire: 'Ce qui fait rire',
            superpouvoir: 'Superpouvoir souhait√©',
            endroitEcole: 'Endroit pr√©f√©r√© √† l\'√©cole',
            momentJournee: 'Moment pr√©f√©r√© de la journ√©e',
            metierReve: 'M√©tier de r√™ve',
            emojiPrefere: 'Emoji pr√©f√©r√©',
            couleurPreferee: 'Couleur pr√©f√©r√©e',
            snackPrefere: 'Snack pr√©f√©r√©',
            motivation: 'Ce qui motive',
            reveFou: 'R√™ve fou'
        };

        // Fonction de d√©cryptage (pour afficher le crush secret)
        function decryptCrushSecret(encryptedText, userId) {
            if (!encryptedText || encryptedText.trim() === '') return '';
            
            try {
                const decoded = atob(encryptedText);
                const parts = decoded.split('|');
                if (parts.length !== 2) return encryptedText;
                
                const encrypted = parts[0];
                const key = parseInt(parts[1]);
                
                let decrypted = '';
                for (let i = 0; i < encrypted.length; i++) {
                    const code = encrypted.charCodeAt(i);
                    
                    if (code >= 65 && code <= 90) {
                        let newCode = code - 65 - key;
                        if (newCode < 0) newCode += 26;
                        decrypted += String.fromCharCode(newCode + 65);
                    } else if (code >= 97 && code <= 122) {
                        let newCode = code - 97 - key;
                        if (newCode < 0) newCode += 26;
                        decrypted += String.fromCharCode(newCode + 97);
                    } else {
                        decrypted += encrypted[i];
                    }
                }
                
                return decrypted;
            } catch (error) {
                console.error('Erreur lors du d√©cryptage:', error);
                return encryptedText;
            }
        }


        // Fonctions pour ouvrir/fermer les modales
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                lucide.createIcons();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Ouvrir la modale de modification de profil
        window.openEditProfileModal = function() {
            openModal('editProfileModal');
        }

        // Ouvrir la modale de visibilit√©
        window.openVisibilityModal = async function() {
            openModal('visibilityModal');
            await loadVisibilityModalContent();
        }

        // Charger le contenu de la modale de visibilit√©
        async function loadVisibilityModalContent() {
            const visibilityModalContent = document.getElementById('visibilityModalContent');
            visibilityModalContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement...</p>';

            try {
                if (!currentUserId) {
                    visibilityModalContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur : utilisateur non connect√©</p>';
                    return;
                }

                // Charger les donn√©es du profil
                const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
                
                if (!userDoc.exists) {
                    visibilityModalContent.innerHTML = '<p class="text-red-400 text-center py-8">Profil non trouv√©</p>';
                    return;
                }

                const userData = userDoc.data();

                // V√©rifier si le profil est compl√©t√©
                if (!userData.profileCompleted || !userData.profileInfo) {
                    visibilityModalContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="user-x" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                            <p class="text-gray-400 mb-4">Tu n'as pas encore rempli ton profil.</p>
                            <button onclick="window.location.href='profile-setup.html'" class="px-6 py-3 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                Remplir mon profil
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Afficher les informations avec toggles
                let html = '<div class="space-y-4">';
                const profileData = userData.profileInfo;

                Object.keys(questionLabels).forEach(key => {
                    if (profileData[key]) {
                        const info = profileData[key];
                        let answer = info.answer || '';
                        const isPublic = info.isPublic || false;
                        const isEncrypted = info.encrypted || false;

                        // D√©crypter le crush secret pour l'affichage
                        if (key === 'crushSecret' && isEncrypted && answer) {
                            answer = decryptCrushSecret(answer, currentUserId);
                        }

                        // Afficher seulement si il y a une r√©ponse
                        if (!answer || answer.trim() === '') {
                            return;
                        }

                        const label = questionLabels[key];
                        const uniqueId = `modal_toggle_${key}`;

                        html += `
                            <div class="card p-4 rounded-xl">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-primary mb-1">${label}</h3>
                                        <p class="text-gray-300 text-sm">${answer}</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-end space-x-3 pt-3 border-t border-gray-700">
                                    <span class="text-sm text-gray-400">Priv√©</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="${uniqueId}" ${isPublic ? 'checked' : ''} class="sr-only peer" onchange="updateProfileVisibility('${key}', this.checked)">
                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                    <span class="text-sm text-gray-400">Public</span>
                                </div>
                            </div>
                        `;
                    }
                });

                html += '</div>';

                if (html === '<div class="space-y-4"></div>') {
                    visibilityModalContent.innerHTML = '<p class="text-gray-500 text-center py-8">Aucune information √† afficher</p>';
                } else {
                    visibilityModalContent.innerHTML = html;
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
                visibilityModalContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement du profil.</p>';
            }
        }

        // Mettre √† jour la visibilit√© d'une information (accessible globalement)
        window.updateProfileVisibility = async function(key, isPublic) {
            try {
                if (!currentUserId) {
                    alert('Erreur : utilisateur non connect√©');
                    return;
                }

                // Mettre √† jour uniquement le flag isPublic pour cette cl√©
                const userRef = firebase.firestore().collection('users').doc(currentUserId);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists || !userDoc.data().profileInfo) {
                    alert('Erreur : profil non trouv√©');
                    return;
                }

                const profileInfo = userDoc.data().profileInfo;
                if (profileInfo[key]) {
                    profileInfo[key].isPublic = isPublic;
                    
                    await userRef.update({
                        'profileInfo': profileInfo
                    });

                    console.log(`‚úÖ Visibilit√© de "${questionLabels[key]}" mise √† jour : ${isPublic ? 'Public' : 'Priv√©'}`);
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour de la visibilit√©:', error);
                alert('Erreur lors de la mise √† jour. Veuillez r√©essayer.');
                // Recharger la modale pour restaurer l'√©tat pr√©c√©dent
                loadVisibilityModalContent();
            }
        }

        // Fermer les modales en cliquant sur l'overlay
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('show');
            }
        });

        // Marquer un message comme lu
        async function markAsRead(messageId) {
            try {
                await firebase.firestore().collection('messages').doc(messageId).update({
                    read: true
                });
                loadNotificationsView();
                loadNotifications();
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du message:', error);
            }
        }

        // D√©connexion
        function signOutAndRedirect() {
            signOutUser().then(() => {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Erreur de d√©connexion:", error);
            });
        }

        // Aller vers admin
        function goToAdmin() {
            window.location.href = 'admin.html';
        }

        // Basculer entre les onglets D√©fis
        window.showDefisTab = function(tab) {
            const progressionView = document.getElementById('defisProgressionView');
            const voteView = document.getElementById('defisVoteView');
            const progressionTab = document.getElementById('defisTabProgression');
            const voteTab = document.getElementById('defisTabVote');

            // Cacher toutes les vues
            progressionView.classList.add('hidden');
            voteView.classList.add('hidden');

            // Retirer l'√©tat actif de tous les onglets
            progressionTab.classList.remove('bg-primary', 'bg-opacity-20', 'text-primary', 'font-semibold', 'border-b-2', 'border-primary');
            progressionTab.classList.add('text-gray-400');
            voteTab.classList.remove('bg-primary', 'bg-opacity-20', 'text-primary', 'font-semibold', 'border-b-2', 'border-primary');
            voteTab.classList.add('text-gray-400');

            if (tab === 'progression') {
                progressionView.classList.remove('hidden');
                progressionTab.classList.add('bg-primary', 'bg-opacity-20', 'text-primary', 'font-semibold', 'border-b-2', 'border-primary');
                progressionTab.classList.remove('text-gray-400');
                loadProgressionView();
            } else if (tab === 'vote') {
                voteView.classList.remove('hidden');
                voteTab.classList.add('bg-primary', 'bg-opacity-20', 'text-primary', 'font-semibold', 'border-b-2', 'border-primary');
                voteTab.classList.remove('text-gray-400');
                loadVoteView();
            }
        }

        // Charger la vue progression
        async function loadProgressionView() {
            const progressionContent = document.getElementById('progressionContent');
            const consecutiveCountEl = document.getElementById('consecutiveCount');
            const progressFill = document.getElementById('progressFill');
            const progressMessage = document.getElementById('progressMessage');

            if (!currentUserId) {
                progressionContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur : utilisateur non connect√©</p>';
                return;
            }

            progressionContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement...</p>';

            try {
                // Charger le script de progression si pas d√©j√† charg√©
                if (typeof calculateProgression === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'js/progression-system.js';
                    document.head.appendChild(script);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                const progression = await calculateProgression();
                
                // Mettre √† jour le compteur
                const consecutiveCount = progression.consecutiveCount;
                consecutiveCountEl.textContent = consecutiveCount;
                
                // Mettre √† jour la barre de progression
                const progressPercentage = Math.min((consecutiveCount / 9) * 100, 100);
                progressFill.style.width = `${progressPercentage}%`;
                const progressText = document.getElementById('progressText');
                if (progressText) {
                    progressText.textContent = `${consecutiveCount} / 9`;
                }
                
                // Message de progression
                if (consecutiveCount >= 9) {
                    progressMessage.textContent = 'üéâ F√©licitations ! Vous avez atteint l\'objectif de 9 personnes cons√©cutives !';
                    progressMessage.classList.remove('text-gray-400');
                    progressMessage.classList.add('text-green-400', 'font-bold');
                } else {
                    progressMessage.textContent = `Il reste ${9 - consecutiveCount} personne(s) pour atteindre l'objectif !`;
                    progressMessage.classList.remove('text-green-400', 'font-bold');
                    progressMessage.classList.add('text-gray-400');
                }
                
                // Afficher les c√©l√©brations
                displayProgressionCelebrations(progression.allCelebrations, consecutiveCount);
                
            } catch (error) {
                console.error('Erreur lors du chargement de la progression:', error);
                progressionContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement de la progression.</p>';
            }
        }

        // Afficher les c√©l√©brations de progression
        function displayProgressionCelebrations(celebrations, consecutiveCount) {
            const container = document.getElementById('progressionContent');
            
            if (celebrations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Aucune c√©l√©bration trouv√©e.</p>';
                return;
            }
            
            // Trouver l'index de d√©but de la s√©quence cons√©cutive
            let streakStartIndex = -1;
            for (let i = 0; i < celebrations.length; i++) {
                if (celebrations[i].completion.complete) {
                    streakStartIndex = i;
                    break;
                }
            }
            
            container.innerHTML = celebrations.map((item, index) => {
                const celeb = item.celebration;
                const completion = item.completion;
                const isComplete = completion.complete;
                const percentage = completion.totalStudents > 0 
                    ? (completion.sentMessages / completion.totalStudents) * 100 
                    : 0;
                
                // V√©rifier si cette c√©l√©bration fait partie de la s√©quence cons√©cutive
                const isInStreak = streakStartIndex >= 0 && index >= streakStartIndex && index < streakStartIndex + consecutiveCount;
                
                // Calculer la date d'anniversaire prochaine
                let formattedDate = 'Date inconnue';
                let daysUntil = null;
                if (celeb.birthday) {
                    const dateParts = celeb.birthday.split('-');
                    if (dateParts.length === 3) {
                        const today = new Date();
                        const currentYear = today.getFullYear();
                        const birthMonth = parseInt(dateParts[1]) - 1;
                        const birthDay = parseInt(dateParts[2]);
                        
                        let nextBirthday = new Date(currentYear, birthMonth, birthDay);
                        if (nextBirthday < today) {
                            nextBirthday = new Date(currentYear + 1, birthMonth, birthDay);
                        }
                        
                        const diffTime = nextBirthday - today;
                        daysUntil = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        formattedDate = nextBirthday.toLocaleDateString('fr-FR', { 
                            day: 'numeric', 
                            month: 'long',
                            year: 'numeric'
                        });
                        
                        if (daysUntil === 0) {
                            formattedDate = `Aujourd'hui - ${formattedDate}`;
                        } else if (daysUntil === 1) {
                            formattedDate = `Demain - ${formattedDate}`;
                        } else if (daysUntil > 0) {
                            formattedDate = `Dans ${daysUntil} jours - ${formattedDate}`;
                        } else {
                            formattedDate = `${formattedDate} (pass√©)`;
                        }
                    }
                }
                
                return `
                    <div class="border border-gray-700 rounded-lg p-4 ${isComplete ? 'bg-green-900 bg-opacity-20 border-green-500' : 'bg-gray-800 bg-opacity-20'}">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="font-bold text-lg">${celeb.fullName || 'N/A'}</h3>
                                <p class="text-sm text-gray-400">${formattedDate}</p>
                            </div>
                            <div class="text-right">
                                ${isComplete ? '<span class="px-3 py-1 rounded-full bg-green-500 text-white text-sm font-bold">‚úì Compl√©t√©</span>' : '<span class="px-3 py-1 rounded-full bg-yellow-500 text-white text-sm font-bold">En cours</span>'}
                            </div>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-6 mb-2 relative">
                            <div class="bg-gradient-to-r from-primary to-secondary h-6 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            <div class="absolute inset-0 flex items-center justify-center font-bold text-xs">
                                ${completion.sentMessages} / ${completion.totalStudents}
                            </div>
                        </div>
                        <p class="text-xs text-gray-400">
                            ${completion.missingStudents.length > 0 
                                ? `${completion.missingStudents.length} √©l√®ve(s) n'ont pas encore envoy√© de message` 
                                : 'Tous les √©l√®ves ont envoy√© un message !'}
                        </p>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        // Initialisation
        // Charger la vue vote
        async function loadVoteView() {
            const voteContent = document.getElementById('voteContent');
            
            if (!currentUserId) {
                voteContent.innerHTML = '<p class="text-red-400 text-center py-8">Vous devez √™tre connect√© pour voter.</p>';
                return;
            }

            // V√©rifier le statut de l'utilisateur
            const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
            const userData = userDoc.data();
            const userStatus = userData.status || 'active';

            // Exclure les spectateurs et les utilisateurs bloqu√©s
            if (userStatus === 'spectator' || userStatus === 'blocked') {
                voteContent.innerHTML = `
                    <div class="bg-red-900 bg-opacity-30 border border-red-500 rounded-lg p-4 text-center">
                        <i data-lucide="ban" class="w-8 h-8 mx-auto mb-2 text-red-400"></i>
                        <p class="text-red-400 font-bold">Acc√®s refus√©</p>
                        <p class="text-gray-400 text-sm mt-2">Votre statut (${userStatus === 'spectator' ? 'Spectateur' : 'Bloqu√©'}) ne vous permet pas de participer aux votes.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            try {
                const [activities, settings] = await Promise.all([
                    getAllActivities(),
                    getVoteSettings()
                ]);
                
                const isFinal = settings.finalVotingEnabled;
                const votingEnabled = settings.votingEnabled || settings.finalVotingEnabled;
                
                if (!votingEnabled) {
                    voteContent.innerHTML = `
                        <div class="bg-yellow-900 bg-opacity-30 border border-yellow-500 rounded-lg p-4 text-center">
                            <i data-lucide="lock" class="w-8 h-8 mx-auto mb-2 text-yellow-400"></i>
                            <p class="text-yellow-400 font-bold">Le vote n'est pas encore activ√©</p>
                            <p class="text-gray-400 text-sm mt-2">Attendez que l'administrateur active le vote.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                if (activities.length === 0) {
                    voteContent.innerHTML = `
                        <div class="bg-gray-800 bg-opacity-30 border border-gray-700 rounded-lg p-4 text-center">
                            <p class="text-gray-400">Aucune activit√© disponible pour le moment.</p>
                        </div>
                    `;
                    return;
                }
                
                // V√©rifier si l'utilisateur a d√©j√† vot√©
                const hasVoted = await hasUserVoted(currentUserId, isFinal);
                const userVote = hasVoted ? await getUserVote(currentUserId, isFinal) : null;
                
                const voteTypeText = isFinal ? 'final' : 'initial';
                const voteTypeLabel = isFinal ? 'Vote Final' : 'Vote Initial';
                
                voteContent.innerHTML = `
                    <div class="mb-4 p-4 bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-blue-400">${voteTypeLabel}</h3>
                                <p class="text-sm text-gray-300 mt-1">
                                    ${isFinal ? 'Votez pour l\'activit√© que vous souhaitez faire !' : 'Votez pour vos activit√©s pr√©f√©r√©es !'}
                                </p>
                            </div>
                            ${hasVoted ? `
                                <span class="px-3 py-1 rounded-full bg-green-500 text-white text-sm font-bold">
                                    ‚úì Vous avez vot√©
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${activities.map(activity => {
                            const isSelected = userVote && userVote.activityId === activity.id;
                            return `
                                <div class="border border-gray-700 rounded-lg p-4 ${isSelected ? 'bg-green-900 bg-opacity-20 border-green-500' : 'bg-gray-800 bg-opacity-20'}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg mb-1">${activity.name}</h3>
                                            ${activity.description ? `<p class="text-sm text-gray-400">${activity.description}</p>` : ''}
                                        </div>
                                        <button 
                                            onclick="submitVoteForActivity('${activity.id}')" 
                                            ${hasVoted ? 'disabled' : ''}
                                            class="px-6 py-2 rounded-lg ${isSelected ? 'bg-green-600' : 'bg-primary hover:bg-secondary'} text-white font-semibold transition ${hasVoted ? 'opacity-50 cursor-not-allowed' : ''}"
                                        >
                                            ${isSelected ? '‚úì S√©lectionn√©' : 'Voter'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement du vote:', error);
                voteContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement du vote.</p>';
            }
        }
        
        // Soumettre un vote pour une activit√©
        async function submitVoteForActivity(activityId) {
            if (!currentUserId) {
                alert('Vous devez √™tre connect√© pour voter.');
                return;
            }
            
            try {
                const settings = await getVoteSettings();
                const isFinal = settings.finalVotingEnabled;
                
                const success = await submitVote(currentUserId, activityId, isFinal);
                
                if (success) {
                    alert('Vote enregistr√© avec succ√®s !');
                    loadVoteView(); // Recharger la vue
                } else {
                    alert('Erreur lors de l\'enregistrement du vote.');
                }
            } catch (error) {
                console.error('Erreur lors de la soumission du vote:', error);
                alert('Erreur lors de la soumission du vote.');
            }
        }



        // Charger les classements
        let leaderboardSystem = null;
        async function loadLeaderboard(type = 'messages') {
            if (!currentUserId) {
                document.getElementById('leaderboardContent').innerHTML = '<p class="text-red-400 text-center py-8">Erreur : utilisateur non connect√©</p>';
                return;
            }

            const leaderboardContent = document.getElementById('leaderboardContent');
            leaderboardContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement du classement...</p>';

            try {
                if (!leaderboardSystem) {
                    leaderboardSystem = new LeaderboardSystem();
                }

                // Mettre √† jour les onglets actifs
                document.querySelectorAll('[id^="leaderboardTab"]').forEach(btn => {
                    btn.classList.remove('bg-primary', 'bg-opacity-20', 'text-primary', 'font-semibold', 'border-b-2', 'border-primary');
                    btn.classList.add('text-gray-400');
                });

                const activeTab = document.getElementById(`leaderboardTab${type.charAt(0).toUpperCase() + type.slice(1)}`);
                if (activeTab) {
                    activeTab.classList.remove('text-gray-400');
                    activeTab.classList.add('bg-primary', 'bg-opacity-20', 'text-primary', 'font-semibold', 'border-b-2', 'border-primary');
                }

                let leaderboard = [];
                let title = '';
                let icon = '';
                let unit = '';

                switch (type) {
                    case 'messages':
                        leaderboard = await leaderboardSystem.getMessagesLeaderboard(10);
                        title = 'Classement par Messages Envoy√©s';
                        icon = 'üí¨';
                        unit = 'messages';
                        break;
                    case 'reputation':
                        leaderboard = await leaderboardSystem.getReputationLeaderboard(10);
                        title = 'Classement par R√©putation';
                        icon = '‚≠ê';
                        unit = '/100';
                        break;
                    case 'points':
                        leaderboard = await leaderboardSystem.getPointsLeaderboard(10);
                        title = 'Classement par Points';
                        icon = 'üèÜ';
                        unit = 'pts';
                        break;
                    case 'activeDays':
                        leaderboard = await leaderboardSystem.getActiveDaysLeaderboard(10);
                        title = 'Classement par Jours Actifs';
                        icon = 'üìÖ';
                        unit = 'jours';
                        break;
                    case 'monthly':
                        leaderboard = await leaderboardSystem.getMonthlyLeaderboard(10);
                        title = 'Classement Mensuel (Messages)';
                        icon = 'üìä';
                        unit = 'messages';
                        break;
                }

                // R√©cup√©rer le rang de l'utilisateur
                const userRank = await leaderboardSystem.getUserRank(currentUserId, type);

                if (leaderboard.length === 0) {
                    leaderboardContent.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="trophy" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                            <p class="text-gray-400 text-lg mb-2">Aucun classement disponible</p>
                            <p class="text-gray-500 text-sm">Les classements seront disponibles une fois que les √©l√®ves commenceront √† participer.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Trouver la position de l'utilisateur dans le top 10
                const userInTop10 = leaderboard.findIndex(item => item.userId === currentUserId);

                leaderboardContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 bg-opacity-20 border border-yellow-500 rounded-lg p-4 mb-6">
                            <h3 class="font-bold text-lg mb-2 flex items-center">
                                <span class="text-2xl mr-2">${icon}</span>
                                ${title}
                            </h3>
                            ${userRank ? `
                                <p class="text-sm text-gray-300 mt-2">
                                    Ta position: <span class="font-bold text-yellow-400">#${userRank}</span>
                                </p>
                            ` : ''}
                        </div>

                        <div class="space-y-2">
                            ${leaderboard.map((item, index) => {
                                const isCurrentUser = item.userId === currentUserId;
                                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                                const rank = index + 1;
                                
                                return `
                                    <div class="bg-bg-dark p-4 rounded-lg flex items-center justify-between transition ${isCurrentUser ? 'border-2 border-primary bg-opacity-80' : 'border border-gray-700'}">
                                        <div class="flex items-center space-x-4 flex-1">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${rank <= 3 ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : 'bg-gray-700'}">
                                                ${medal || rank}
                                            </div>
                                            <div class="flex-1">
                                                <h4 class="font-bold ${isCurrentUser ? 'text-primary' : ''}">
                                                    ${item.name} ${isCurrentUser ? '(Toi)' : ''}
                                                </h4>
                                                ${item.level ? `<p class="text-xs text-gray-400">Niveau ${item.level}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-bold ${rank <= 3 ? 'text-yellow-400' : ''}">
                                                ${item.value} ${unit}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${userRank && userRank > 10 ? `
                            <div class="bg-bg-dark p-4 rounded-lg border-2 border-primary mt-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center font-bold">
                                            ${userRank}
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-primary">Toi</h4>
                                            <p class="text-xs text-gray-400">Position actuelle</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold text-primary">
                                            ${leaderboard.find(item => item.userId === currentUserId)?.value || 0} ${unit}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement du classement:', error);
                leaderboardContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement du classement.</p>';
            }
        }

        // Charger les annonces
        let announcementsSystem = null;
        async function loadAnnouncements() {
            if (!currentUserId) return;
            const announcementsBanner = document.getElementById('announcementsBanner');
            if (!announcementsBanner) return;
            try {
                if (!announcementsSystem) {
                    announcementsSystem = new AnnouncementsSystem();
                }
                const announcements = await announcementsSystem.getActiveAnnouncements(currentUserId);
                if (announcements.length === 0) {
                    announcementsBanner.innerHTML = '';
                    return;
                }
                // Mapping des priorit√©s vers les classes Bootstrap alert
                const priorityAlertClasses = {
                    'urgent': 'alert-danger',
                    'high': 'alert-warning',
                    'normal': 'alert-info',
                    'low': 'alert-secondary'
                };
                
                const priorityIcons = {
                    'urgent': 'alert-triangle',
                    'high': 'alert-circle',
                    'normal': 'info',
                    'low': 'bell'
                };
                
                announcementsBanner.innerHTML = announcements.map(announcement => {
                    const date = announcement.createdAt?.toDate ? announcement.createdAt.toDate() : new Date();
                    const formattedDate = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    const isUnread = !announcement.isRead;
                    const alertClass = priorityAlertClasses[announcement.priority] || 'alert-info';
                    const icon = priorityIcons[announcement.priority] || 'info';
                    
                    return `
                        <div class="alert ${alertClass} flex items-start" role="alert">
                            <i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0 mr-2 mt-0.5"></i>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="alert-heading font-bold text-lg mb-0">${announcement.title}</h4>
                                    ${isUnread ? '<span class="px-2 py-1 rounded-full bg-primary text-white text-xs font-bold animate-pulse">Nouveau</span>' : ''}
                                </div>
                                <p class="text-sm opacity-75 mb-2">${formattedDate}</p>
                                <p class="mb-0 whitespace-pre-wrap">${announcement.content}</p>
                            </div>
                            ${isUnread ? `
                                <button onclick="markAnnouncementAsRead('${announcement.id}')" 
                                        class="ml-4 p-2 rounded-lg bg-opacity-20 hover:bg-opacity-30 transition flex-shrink-0" 
                                        title="Marquer comme lu">
                                    <i data-lucide="check" class="w-5 h-5"></i>
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement des annonces:', error);
            }
        }

        async function markAnnouncementAsRead(announcementId) {
            if (!currentUserId) return;
            try {
                if (!announcementsSystem) {
                    announcementsSystem = new AnnouncementsSystem();
                }
                await announcementsSystem.markAsRead(announcementId, currentUserId);
                await loadAnnouncements();
            } catch (error) {
                console.error('Erreur lors du marquage comme lu:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuth();
        });
    </script>
</body>
</html>
