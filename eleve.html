<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendrier ‚Äî F√™te Express</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #ff6f61;
            --secondary: #f9c74f;
            --bg-dark: #1a0f30;
            --bg-light: #2c1a4b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: white;
            min-height: 100vh;
        }
        .header-gradient {
            background-image: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background-color: var(--bg-light);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .sidebar {
            width: 250px;
            min-height: calc(100vh - 2rem);
            transition: transform 0.3s ease;
        }
        .sidebar-item {
            transition: all 0.2s;
        }
        .sidebar-item:hover {
            background-color: rgba(255, 111, 97, 0.1);
        }
        .sidebar-item.active {
            background-color: rgba(255, 111, 97, 0.2);
            border-left: 3px solid var(--primary);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .calendar-day {
            min-height: 150px;
        }
        /* Styles pour les textareas de messages */
        textarea {
            color: white !important;
            background-color: var(--bg-dark) !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
            transition: all 0.3s ease;
        }
        textarea:focus {
            outline: none !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px rgba(255, 111, 97, 0.2) !important;
            background-color: rgba(26, 15, 48, 0.8) !important;
        }
        textarea::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        /* Style pour les cartes de messages */
        .message-card {
            background: linear-gradient(135deg, var(--bg-light) 0%, rgba(44, 26, 75, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }
        /* Modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal-content {
            background-color: var(--bg-light);
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        /* Style pour les boutons d'envoi */
        .send-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            transition: all 0.3s ease;
        }
        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 111, 97, 0.4);
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                min-height: auto;
            }
        }
    </style>
</head>

<body class="p-4 md:p-8">
    
    <!-- √âcran de chargement -->
    <div id="loadingScreen" class="fixed inset-0 bg-bg-dark flex flex-col justify-center items-center z-50">
        <div class="text-xl text-white">Chargement du calendrier...</div>
        <div class="loading my-4 flex space-x-2">
            <div class="w-4 h-4 rounded-full bg-primary animate-bounce"></div>
            <div class="w-4 h-4 rounded-full bg-secondary animate-bounce delay-150"></div>
            <div class="w-4 h-4 rounded-full bg-primary animate-bounce delay-300"></div>
        </div>
    </div>

    <!-- Contenu principal -->
    <main id="mainContent" class="hidden flex flex-col md:flex-row gap-6">
        <!-- Sidebar -->
        <aside class="sidebar card p-4 rounded-xl">
            <div class="mb-6">
                <h2 class="text-xl font-bold mb-4">
                    <span class="header-gradient">Navigation</span>
                </h2>
                <nav class="space-y-2">
                    <button onclick="showView('liste')" id="btnListe" class="sidebar-item active w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="list" class="w-5 h-5"></i>
                        <span>Liste</span>
                    </button>
                    <button onclick="showView('calendrier')" id="btnCalendrier" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="calendar" class="w-5 h-5"></i>
                        <span>Calendrier</span>
                    </button>
                    <button onclick="showView('notifications')" id="btnNotifications" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3 relative">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span>Messages</span>
                        <span id="notificationBadge" class="hidden ml-auto bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                    </button>
                    <button onclick="window.location.href='progression.html'" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                        <span>Progression</span>
                    </button>
                    <button onclick="showView('vote')" id="btnVote" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3">
                        <i data-lucide="vote" class="w-5 h-5"></i>
                        <span>Vote Activit√©s</span>
                    </button>
                    <button onclick="showView('profiles')" id="btnProfiles" class="sidebar-item w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3 hidden">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span>Profils</span>
                    </button>
                </nav>
            </div>
            
            <div class="mt-auto pt-6 border-t border-gray-700">
                <div class="text-sm mb-4">
                    <span id="welcomeName" class="text-gray-400"></span>
                </div>
                <div class="flex flex-col space-y-2">
                    <button onclick="goToAdmin()" id="adminBtn" class="hidden flex items-center text-sm px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 transition">
                        <i data-lucide="shield" class="w-4 h-4 mr-2"></i>
                        Admin
                    </button>
                    <button onclick="signOutAndRedirect()" class="flex items-center text-sm px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                        D√©connexion
                    </button>
                </div>
            </div>
        </aside>

        <!-- Contenu principal -->
        <div class="flex-1">
            <header class="mb-6">
                <h1 class="text-3xl md:text-4xl font-extrabold mb-2">
                    <span class="header-gradient" id="pageTitle">Liste des Anniversaires</span>
                </h1>
            </header>

            <!-- Vue Liste -->
            <section id="viewListe" class="card p-6 rounded-xl">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i data-lucide="list" class="w-6 h-6 mr-2"></i>
                    Prochains Anniversaires
                </h2>
                <p class="text-sm text-gray-400 mb-6">Liste des anniversaires √† venir dans la classe 203</p>
                
                <div id="celebrationsList" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Chargement des anniversaires...</p>
                </div>
            </section>

            <!-- Vue Calendrier -->
            <section id="viewCalendrier" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i data-lucide="calendar" class="w-6 h-6 mr-2"></i>
                    Calendrier des Anniversaires
                </h2>
                <p class="text-sm text-gray-400 mb-6">Tous les anniversaires de l'ann√©e</p>
                
                <div id="calendarContainer" class="calendar-grid">
                    <p class="text-gray-500 text-center py-8 col-span-full">Chargement du calendrier...</p>
                </div>
            </section>

            <!-- Vue Messages -->
            <section id="viewNotifications" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i data-lucide="bell" class="w-6 h-6 mr-2"></i>
                    Mes Messages
                </h2>
                
                <!-- Section pour envoyer des messages (si anniversaire dans 1 semaine ou moins) -->
                <div id="sendMessageSection" class="mb-6 hidden">
                    <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4 mb-4">
                        <h3 class="font-bold mb-2 flex items-center">
                            <i data-lucide="gift" class="w-5 h-5 mr-2"></i>
                            Anniversaires √† venir (dans 1 semaine ou moins)
                        </h3>
                        <p class="text-sm text-gray-300 mb-4">Tu peux envoyer un message secret ou public √† ces personnes pour leur souhaiter un joyeux anniversaire !</p>
                        <div id="upcomingBirthdays" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Explication si la f√™te n'a pas encore pass√© -->
                <div id="birthdayExplanation" class="bg-gradient-to-r from-primary to-secondary bg-opacity-20 border border-primary rounded-lg p-4 mb-6 hidden">
                    <h3 class="font-bold mb-2 flex items-center">
                        <i data-lucide="info" class="w-5 h-5 mr-2"></i>
                        Comment √ßa marche ?
                    </h3>
                    <p class="text-sm">
                        <strong>Ton anniversaire approche !</strong> Quand ton anniversaire est dans 1 semaine ou moins, 
                        tes camarades peuvent t'envoyer des messages secrets ou publics pour te souhaiter un joyeux anniversaire. 
                        Tu recevras ces messages ici dans tes messages. Les messages secrets restent priv√©s, 
                        tandis que les messages publics peuvent √™tre vus par tous. üéâ
                    </p>
                </div>

                <!-- Liste des messages re√ßus -->
                <div class="mb-4">
                    <h3 class="text-xl font-bold mb-4">Messages re√ßus</h3>
                    <div id="messagesList" class="space-y-4">
                        <p class="text-gray-500 text-center py-8">Chargement de tes messages...</p>
                    </div>
                </div>
            </section>

            <!-- Vue Vote -->
            <section id="viewVote" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-4 flex items-center">
                    <i data-lucide="vote" class="w-6 h-6 mr-2"></i>
                    Vote pour les Activit√©s
                </h2>
                <div id="voteContent">
                    <p class="text-gray-500 text-center py-8">Chargement...</p>
                </div>
            </section>

            <!-- Vue Profils -->
            <section id="viewProfiles" class="card p-6 rounded-xl hidden">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <i data-lucide="users" class="w-6 h-6 mr-2"></i>
                    Profils
                </h2>
                
                <!-- Boutons d'action -->
                <div class="flex flex-wrap gap-4 mb-8">
                    <button onclick="openEditProfileModal()" class="flex items-center px-6 py-3 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                        <i data-lucide="edit" class="w-5 h-5 mr-2"></i>
                        Modifier mon profil
                    </button>
                    <button onclick="openVisibilityModal()" class="flex items-center px-6 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition">
                        <i data-lucide="eye" class="w-5 h-5 mr-2"></i>
                        Modifier la visibilit√© de mes informations
                    </button>
                </div>

                <!-- Section Profils des Autres √âl√®ves -->
                <div id="otherProfilesSection">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                        Profils des Autres √âl√®ves
                    </h3>
                    <div id="profilesContent">
                        <p class="text-gray-500 text-center py-8">Chargement...</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modale Modifier le Profil -->
    <div id="editProfileModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i data-lucide="edit" class="w-6 h-6 mr-2"></i>
                    Modifier mon profil
                </h3>
                <button onclick="closeModal('editProfileModal')" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-400 mb-6 text-sm">
                Pour modifier tes informations, tu dois remplir √† nouveau le formulaire complet.
            </p>
            <div class="flex justify-end space-x-4">
                <button onclick="closeModal('editProfileModal')" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700 transition">
                    Annuler
                </button>
                <button onclick="window.location.href='profile-setup.html'" class="px-4 py-2 rounded bg-primary hover:bg-opacity-90 text-white transition">
                    Aller au formulaire
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Modifier la Visibilit√© -->
    <div id="visibilityModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <i data-lucide="eye" class="w-6 h-6 mr-2"></i>
                    Modifier la visibilit√© de mes informations
                </h3>
                <button onclick="closeModal('visibilityModal')" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-400 mb-6 text-sm">
                Choisis quelles informations tu veux rendre visibles aux autres √©l√®ves. Les informations priv√©es ne seront visibles que par les administrateurs.
            </p>
            <div id="visibilityModalContent">
                <p class="text-gray-500 text-center py-8">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Inclusion du fichier firebase.js -->
    <script src="firebase.js"></script>
    <script src="js/vote-system.js"></script>

    <script>
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContent = document.getElementById('mainContent');
        const welcomeName = document.getElementById('welcomeName');
        const adminBtn = document.getElementById('adminBtn');
        const celebrationsList = document.getElementById('celebrationsList');
        const calendarContainer = document.getElementById('calendarContainer');
        const pageTitle = document.getElementById('pageTitle');
        const notificationBadge = document.getElementById('notificationBadge');
        let allCelebrations = [];
        let currentUserId = null;
        let currentUserBirthday = null;

        // Configuration de l'API Email
        // D√©tection automatique : localhost en d√©veloppement, URL de production sinon
        const EMAIL_API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3001/api'
            : 'https://votre-serveur-email.com/api'; // √Ä configurer pour la production

        /**
         * Envoie une notification par email lorsqu'un message est re√ßu
         * @param {string} email - Email du destinataire
         * @param {string} recipientName - Nom du destinataire
         * @param {string} senderName - Nom de l'exp√©diteur
         * @param {string} message - Contenu du message
         * @param {boolean} isPublic - Si le message est public
         * @param {string} birthdayMessage - Message d'anniversaire optionnel
         * @returns {Promise<boolean>} Succ√®s ou √©chec
         */
        async function sendMessageNotification(email, recipientName, senderName, message, isPublic, birthdayMessage = '') {
            try {
                const response = await fetch(`${EMAIL_API_URL}/send-message-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        recipientName: recipientName,
                        senderName: senderName,
                        message: message,
                        isPublic: isPublic,
                        notificationsUrl: window.location.origin + '/eleve.html#notifications',
                        birthdayMessage: birthdayMessage || ''
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ Notification email envoy√©e √†', email);
                    return true;
                } else {
                    console.error('‚ùå Erreur envoi notification:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'envoi de la notification:', error);
                // Ne pas bloquer l'envoi du message si la notification √©choue
                return false;
            }
        }

        // V√©rifier l'authentification
        async function checkAuth() {
            loadingScreen.style.display = 'flex';
            
            const user = await new Promise(resolve => {
                const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                    unsubscribe();
                    resolve(u);
                });
            });

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // V√©rifier si le profil est compl√©t√© (seulement pour les √©l√®ves)
            const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
            const docData = userDoc.data();
            if (docData) {
                // Si c'est un √©l√®ve et que le profil n'est pas compl√©t√©, rediriger
                if (docData.role === 'eleve' && !docData.profileCompleted) {
                    window.location.href = 'profile-setup.html';
                    return;
                }
            }

            const userData = await getUserRole(user.uid);
            welcomeName.textContent = `Bienvenue, ${userData.name}`;
            currentUserId = user.uid;

            // R√©cup√©rer la date d'anniversaire de l'utilisateur
            if (docData && docData.email) {
                const fileNumber = docData.email.split('@')[0];
                const userCelebration = await firebase.firestore().collection('celebrations')
                    .where('fileNumber', '==', fileNumber)
                    .limit(1)
                    .get();
                
                if (!userCelebration.empty) {
                    currentUserBirthday = userCelebration.docs[0].data().birthday;
                }
            }

            // Afficher le bouton admin si l'utilisateur est admin
            if (userData.role === 'admin') {
                adminBtn.classList.remove('hidden');
            }

            // V√©rifier si la visibilit√© des profils est activ√©e
            const settingsDoc = await firebase.firestore().collection('settings').doc('profileVisibility').get();
            const profileVisibilityEnabled = settingsDoc.exists && settingsDoc.data().enabled || false;
            
            if (profileVisibilityEnabled) {
                const btnProfiles = document.getElementById('btnProfiles');
                if (btnProfiles) btnProfiles.classList.remove('hidden');
            }

            loadingScreen.style.display = 'none';
            mainContent.classList.remove('hidden');
            
            loadCelebrations();
            loadNotifications();
        }

        // Calculer l'√¢ge actuel
        function calculateAge(birthday) {
            if (!birthday) return 'N/A';
            const dateParts = birthday.split('-');
            if (dateParts.length !== 3) return 'N/A';
            
            const birthDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Charger les c√©l√©brations
        function loadCelebrations() {
            firebase.firestore().collection('celebrations')
                .orderBy('birthday', 'asc')
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        celebrationsList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun anniversaire enregistr√© pour le moment.</p>';
                        allCelebrations = [];
                        return;
                    }

                    allCelebrations = [];
                    snapshot.forEach(doc => {
                        allCelebrations.push({ id: doc.id, ...doc.data() });
                    });

                    // Charger la vue actuelle
                    const currentView = document.querySelector('.sidebar-item.active')?.id;
                    if (currentView === 'btnListe') {
                        loadListView();
                    } else if (currentView === 'btnCalendrier') {
                        loadCalendarView();
                    } else if (currentView === 'btnNotifications') {
                        loadNotificationsView();
                    }
                    
                    // Mettre √† jour les notifications
                    loadNotifications();
                }, error => {
                    console.error("Erreur lors du chargement:", error);
                    celebrationsList.innerHTML = '<p class="text-red-400 text-center py-8">Erreur de chargement des donn√©es.</p>';
                });
        }

        // Charger la vue liste
        function loadListView() {
            if (allCelebrations.length === 0) {
                celebrationsList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun anniversaire enregistr√© pour le moment.</p>';
                return;
            }

            celebrationsList.innerHTML = '';
            allCelebrations.forEach(data => {
                const card = document.createElement('div');
                card.className = 'bg-bg-dark p-4 rounded-lg flex items-center justify-between hover:bg-opacity-80 transition';
                
                const dateParts = data.birthday ? data.birthday.split('-') : ['?', '?', '?'];
                const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}` : 'N/A';
                const age = calculateAge(data.birthday);
                
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-2xl">
                            üéÇ
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">${data.fullName || 'N/A'}</h3>
                            <p class="text-sm text-gray-400">Anniversaire: ${formattedDate} ‚Ä¢ ${age} ans</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-xs text-gray-500">${data.classNumber || 'N/A'}</span>
                    </div>
                `;
                celebrationsList.appendChild(card);
            });
            lucide.createIcons();
        }

        // Charger la vue calendrier
        function loadCalendarView() {
            if (allCelebrations.length === 0) {
                calendarContainer.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">Aucun anniversaire enregistr√© pour le moment.</p>';
                return;
            }

            // Organiser les anniversaires par mois
            const celebrationsByMonth = {};
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

            allCelebrations.forEach(celeb => {
                if (!celeb.birthday) return;
                const dateParts = celeb.birthday.split('-');
                if (dateParts.length !== 3) return;
                
                const month = parseInt(dateParts[1]) - 1;
                const day = parseInt(dateParts[2]);
                
                if (!celebrationsByMonth[month]) {
                    celebrationsByMonth[month] = [];
                }
                
                celebrationsByMonth[month].push({
                    ...celeb,
                    day: day,
                    age: calculateAge(celeb.birthday)
                });
            });

            // Cr√©er le calendrier
            calendarContainer.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthCard = document.createElement('div');
                monthCard.className = 'calendar-day card p-4 rounded-lg';
                
                const monthCelebrations = celebrationsByMonth[month] || [];
                monthCelebrations.sort((a, b) => a.day - b.day);
                
                let content = `
                    <h3 class="font-bold text-lg mb-3 text-primary">${monthNames[month]}</h3>
                `;
                
                if (monthCelebrations.length === 0) {
                    content += '<p class="text-gray-500 text-sm">Aucun anniversaire</p>';
                } else {
                    content += '<div class="space-y-2">';
                    monthCelebrations.forEach(celeb => {
                        const dateParts = celeb.birthday.split('-');
                        const formattedDate = `${celeb.day}/${parseInt(dateParts[1])}`;
                        content += `
                            <div class="bg-bg-dark p-2 rounded text-sm">
                                <div class="font-semibold">${celeb.fullName || 'N/A'}</div>
                                <div class="text-gray-400 text-xs">${formattedDate} ‚Ä¢ ${celeb.age} ans</div>
                            </div>
                        `;
                    });
                    content += '</div>';
                }
                
                monthCard.innerHTML = content;
                calendarContainer.appendChild(monthCard);
            }
            
            lucide.createIcons();
        }

        // Basculer entre les vues
        function showView(view) {
            const viewListe = document.getElementById('viewListe');
            const viewCalendrier = document.getElementById('viewCalendrier');
            const viewNotifications = document.getElementById('viewNotifications');
            const viewVote = document.getElementById('viewVote');
            const viewProfiles = document.getElementById('viewProfiles');
            const btnListe = document.getElementById('btnListe');
            const btnCalendrier = document.getElementById('btnCalendrier');
            const btnNotifications = document.getElementById('btnNotifications');
            const btnVote = document.getElementById('btnVote');
            const btnProfiles = document.getElementById('btnProfiles');

            // Cacher toutes les vues
            viewListe.classList.add('hidden');
            viewCalendrier.classList.add('hidden');
            if (viewVote) viewVote.classList.add('hidden');
            viewNotifications.classList.add('hidden');
            if (viewProfiles) viewProfiles.classList.add('hidden');
            
            // Retirer l'√©tat actif de tous les boutons
            btnListe.classList.remove('active');
            btnCalendrier.classList.remove('active');
            btnNotifications.classList.remove('active');
            if (btnVote) btnVote.classList.remove('active');
            if (btnProfiles) btnProfiles.classList.remove('active');

            if (view === 'liste') {
                viewListe.classList.remove('hidden');
                btnListe.classList.add('active');
                pageTitle.textContent = 'Liste des Anniversaires';
                loadListView();
            } else if (view === 'calendrier') {
                viewCalendrier.classList.remove('hidden');
                btnCalendrier.classList.add('active');
                pageTitle.textContent = 'Calendrier des Anniversaires';
                loadCalendarView();
            } else if (view === 'notifications') {
                viewNotifications.classList.remove('hidden');
                btnNotifications.classList.add('active');
                pageTitle.textContent = 'Mes Messages';
                loadNotificationsView();
            } else if (view === 'vote' && viewVote) {
                viewVote.classList.remove('hidden');
                if (btnVote) btnVote.classList.add('active');
                pageTitle.textContent = 'Vote pour les Activit√©s';
                loadVoteView();
            } else if (view === 'profiles' && viewProfiles) {
                viewProfiles.classList.remove('hidden');
                if (btnProfiles) btnProfiles.classList.add('active');
                pageTitle.textContent = 'Profils';
                loadProfilesView();
            }
            
            lucide.createIcons();
        }

        // Calculer les jours jusqu'√† l'anniversaire
        function daysUntilBirthday(birthday) {
            if (!birthday) return null;
            const dateParts = birthday.split('-');
            if (dateParts.length !== 3) return null;
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const birthMonth = parseInt(dateParts[1]) - 1;
            const birthDay = parseInt(dateParts[2]);
            
            // Date d'anniversaire cette ann√©e
            let birthdayThisYear = new Date(currentYear, birthMonth, birthDay);
            
            // Si l'anniversaire est d√©j√† pass√© cette ann√©e, prendre l'ann√©e prochaine
            if (birthdayThisYear < today) {
                birthdayThisYear = new Date(currentYear + 1, birthMonth, birthDay);
            }
            
            const diffTime = birthdayThisYear - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Charger les anniversaires √† venir (dans 1 semaine ou moins)
        async function loadUpcomingBirthdays() {
            const upcomingBirthdaysDiv = document.getElementById('upcomingBirthdays');
            const sendMessageSection = document.getElementById('sendMessageSection');
            
            if (!allCelebrations.length) {
                sendMessageSection.classList.add('hidden');
                return;
            }

            const upcoming = [];
            allCelebrations.forEach(celeb => {
                if (!celeb.birthday) return;
                const days = daysUntilBirthday(celeb.birthday);
                if (days !== null && days >= 0 && days <= 7) {
                    upcoming.push({ ...celeb, daysUntil: days });
                }
            });

            if (upcoming.length === 0) {
                sendMessageSection.classList.add('hidden');
                return;
            }

            sendMessageSection.classList.remove('hidden');
            upcomingBirthdaysDiv.innerHTML = '';

            // V√©rifier pour chaque personne si un message a d√©j√† √©t√© envoy√©
            for (const person of upcoming) {
                let messageAlreadySent = false;
                
                if (currentUserId) {
                    const existingMessage = await firebase.firestore().collection('messages')
                        .where('senderId', '==', currentUserId)
                        .where('celebrationId', '==', person.id)
                        .limit(1)
                        .get();
                    
                    messageAlreadySent = !existingMessage.empty;
                }

                const card = document.createElement('div');
                card.className = 'message-card p-5 rounded-xl mb-4';
                
                const dateParts = person.birthday.split('-');
                const formattedDate = `${dateParts[2]}/${dateParts[1]}`;
                const daysText = person.daysUntil === 0 ? "Aujourd'hui ! üéâ" : 
                                person.daysUntil === 1 ? "Demain ! üéÇ" : 
                                `Dans ${person.daysUntil} jours`;

                const buttonDisabled = messageAlreadySent ? 'disabled opacity-50 cursor-not-allowed' : '';
                const buttonText = messageAlreadySent ? 'D√©j√† envoy√© ‚úì' : 'Envoyer';
                const textareaDisabled = messageAlreadySent ? 'disabled opacity-50 cursor-not-allowed' : '';
                const textareaPlaceholder = messageAlreadySent ? 'Vous avez d√©j√† envoy√© un message √† cette personne.' : '√âcris un message personnalis√© pour souhaiter un joyeux anniversaire... üéâ';

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-700">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-xl">
                                üéÇ
                            </div>
                            <div>
                                <h4 class="font-bold text-lg">${person.fullName || 'N/A'}</h4>
                                <p class="text-sm text-gray-400">${formattedDate} ‚Ä¢ <span class="text-primary font-semibold">${daysText}</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-300">Ton message</label>
                                ${!messageAlreadySent ? `
                                    <button onclick="generateBirthdayMessage('${person.id}')" class="flex items-center px-3 py-1.5 rounded-lg bg-secondary hover:bg-opacity-90 text-bg-dark text-xs font-semibold transition">
                                        <i data-lucide="sparkles" class="w-3 h-3 mr-1"></i>
                                        G√©n√©rer un message
                                    </button>
                                ` : ''}
                            </div>
                            <textarea id="message_${person.id}" ${messageAlreadySent ? 'disabled' : ''} class="w-full p-3 rounded-lg text-white text-sm resize-none ${textareaDisabled}" placeholder="${textareaPlaceholder}" rows="3"></textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center space-x-2 cursor-pointer group">
                                <input type="checkbox" id="public_${person.id}" ${messageAlreadySent ? 'disabled' : ''} class="w-4 h-4 rounded border-gray-600 bg-bg-dark text-primary focus:ring-primary focus:ring-2 ${messageAlreadySent ? 'opacity-50 cursor-not-allowed' : ''}">
                                <span class="text-sm text-gray-300 group-hover:text-white transition">Message public (visible par tous)</span>
                            </label>
                            <button onclick="${messageAlreadySent ? '' : `sendMessage('${person.id}', '${person.fullName}')`}" ${messageAlreadySent ? 'disabled' : ''} class="send-button px-6 py-2 rounded-lg text-white text-sm font-semibold flex items-center space-x-2 ${buttonDisabled}">
                                <i data-lucide="${messageAlreadySent ? 'check' : 'send'}" class="w-4 h-4"></i>
                                <span>${buttonText}</span>
                            </button>
                        </div>
                    </div>
                `;
                upcomingBirthdaysDiv.appendChild(card);
            }

            lucide.createIcons();
        }

        // Envoyer un message
        async function sendMessage(celebrationId, recipientName) {
            const messageText = document.getElementById(`message_${celebrationId}`).value.trim();
            const isPublic = document.getElementById(`public_${celebrationId}`).checked;

            if (!messageText) {
                alert('Veuillez √©crire un message !');
                return;
            }

            if (!currentUserId) {
                alert('Erreur : utilisateur non connect√©');
                return;
            }

            // V√©rifier le statut et la r√©putation de l'utilisateur
            const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
            const userData = userDoc.data();
            const userStatus = userData.status || 'active';
            const userReputation = userData.reputation || 100;

            // V√©rifier si l'utilisateur est bloqu√© ou spectateur
            if (userStatus === 'blocked' || userStatus === 'spectator') {
                alert(`‚ö†Ô∏è Vous ne pouvez pas envoyer de messages. Statut: ${userStatus === 'blocked' ? 'Bloqu√©' : 'Spectateur'}`);
                return;
            }

            // V√©rifier si la r√©putation est trop basse
            if (userReputation < 50) {
                alert(`‚ö†Ô∏è Votre r√©putation est trop faible (${userReputation}/100) pour envoyer des messages. Veuillez am√©liorer votre comportement.`);
                return;
            }

            // R√©cup√©rer l'ID utilisateur du destinataire (n√©cessaire pour l'enregistrement des messages bloqu√©s)
            const celebration = allCelebrations.find(c => c.id === celebrationId);
            if (!celebration || !celebration.fileNumber) {
                alert('Erreur : impossible de trouver le destinataire');
                return;
            }

            // Trouver l'utilisateur par fileNumber
            const recipientUsers = await firebase.firestore().collection('users')
                .where('email', '==', `${celebration.fileNumber}@cslaval.qc.ca`)
                .limit(1)
                .get();

            if (recipientUsers.empty) {
                alert('Erreur : utilisateur destinataire non trouv√©');
                return;
            }

            const recipientId = recipientUsers.docs[0].id;
            const senderData = await firebase.firestore().collection('users').doc(currentUserId).get();
            const senderName = senderData.data()?.fullName || 'Anonyme';

            // Valider le message (v√©rifier les mots interdits)
            const validation = validateMessage(messageText);
            if (!validation.valid) {
                // D√©cr√©menter la r√©putation
                const newReputation = Math.max(0, userReputation - 5);
                await firebase.firestore().collection('users').doc(currentUserId).update({
                    reputation: newReputation
                });

                // Enregistrer le message bloqu√© dans Firestore
                try {
                    await firebase.firestore().collection('blockedMessages').add({
                        userId: currentUserId,
                        userName: senderName,
                        message: messageText,
                        recipientId: recipientId,
                        recipientName: recipientName,
                        celebrationId: celebrationId,
                        reputationBefore: userReputation,
                        reputationAfter: newReputation,
                        blockedWord: validation.word || 'inconnu',
                        reason: validation.reason,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Erreur lors de l\'enregistrement du message bloqu√©:', error);
                }

                // Si la r√©putation tombe en dessous de 50, bloquer les messages
                if (newReputation < 50) {
                    await firebase.firestore().collection('users').doc(currentUserId).update({
                        status: 'blocked'
                    });
                    alert(`‚ö†Ô∏è ${validation.reason}\n\nVotre r√©putation a √©t√© r√©duite √† ${newReputation}/100. Vous ne pouvez plus envoyer de messages jusqu'√† ce que votre r√©putation s'am√©liore.`);
                } else {
                    alert(`‚ö†Ô∏è ${validation.reason}\n\nVotre r√©putation a √©t√© r√©duite √† ${newReputation}/100. Veuillez modifier votre message avant de l'envoyer.`);
                }
                
                // Mettre en √©vidence le textarea avec une bordure rouge
                const textarea = document.getElementById(`message_${celebrationId}`);
                textarea.style.borderColor = '#ef4444';
                textarea.style.borderWidth = '2px';
                textarea.focus();
                
                // Retirer la bordure rouge apr√®s 3 secondes
                setTimeout(() => {
                    textarea.style.borderColor = '';
                    textarea.style.borderWidth = '';
                }, 3000);
                
                return;
            }

            // Les informations du destinataire et de l'exp√©diteur sont d√©j√† r√©cup√©r√©es plus haut
            const recipientData = recipientUsers.docs[0].data();
            const recipientEmail = recipientData.email;

            // V√©rifier si l'utilisateur a d√©j√† envoy√© un message √† cette personne
            const existingMessage = await firebase.firestore().collection('messages')
                .where('senderId', '==', currentUserId)
                .where('celebrationId', '==', celebrationId)
                .limit(1)
                .get();

            if (!existingMessage.empty) {
                alert('‚ö†Ô∏è Vous avez d√©j√† envoy√© un message √† cette personne. Vous ne pouvez envoyer qu\'un seul message par personne.');
                return;
            }

            try {
                await firebase.firestore().collection('messages').add({
                    recipientId: recipientId,
                    senderId: currentUserId,
                    senderName: senderName,
                    recipientName: recipientName,
                    message: messageText,
                    isPublic: isPublic,
                    celebrationId: celebrationId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });

                // Envoyer une notification par email
                // Adapter le message selon le contexte (anniversaire ou message g√©n√©ral)
                let birthdayMessage = '';
                if (celebration && celebration.birthday) {
                    const days = daysUntilBirthday(celebration.birthday);
                    if (days !== null && days >= 0 && days <= 7) {
                        birthdayMessage = days === 0 ? "C'est ton anniversaire aujourd'hui ! üéâ" : 
                                         days === 1 ? "C'est ton anniversaire demain ! üéÇ" : 
                                         `Ton anniversaire est dans ${days} jours !`;
                    }
                }
                
                // Envoyer la notification par email (fonctionne pour tous les r√¥les)
                await sendMessageNotification(
                    recipientEmail,
                    recipientName,
                    senderName,
                    messageText,
                    isPublic,
                    birthdayMessage || 'Tu as re√ßu un nouveau message !'
                );

                // R√©initialiser le formulaire
                document.getElementById(`message_${celebrationId}`).value = '';
                document.getElementById(`public_${celebrationId}`).checked = false;

                alert('Message envoy√© avec succ√®s ! üéâ');
                
                // V√©rifier la progression des 9 personnes cons√©cutives
                try {
                    // Charger le script de progression si pas d√©j√† charg√©
                    if (typeof checkAndNotify9Consecutive === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'js/progression-system.js';
                        document.head.appendChild(script);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    await checkAndNotify9Consecutive();
                } catch (error) {
                    console.error('Erreur lors de la v√©rification de progression:', error);
                }
                
                // Recharger les anniversaires √† venir pour mettre √† jour l'√©tat des boutons
                await loadUpcomingBirthdays();
                loadNotifications();
            } catch (error) {
                console.error('Erreur lors de l\'envoi du message:', error);
                alert('Erreur lors de l\'envoi du message');
            }
        }

        // Charger les notifications
        async function loadNotifications() {
            if (!currentUserId) return;

            try {
                const messagesSnapshot = await firebase.firestore().collection('messages')
                    .where('recipientId', '==', currentUserId)
                    .get();

                // Trier c√¥t√© client pour √©viter le besoin d'index composite
                const messages = messagesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                const unreadCount = messages.filter(msg => !msg.read).length;
                
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des notifications:', error);
            }
        }

        // Charger la vue notifications
        async function loadNotificationsView() {
            const messagesList = document.getElementById('messagesList');
            const birthdayExplanation = document.getElementById('birthdayExplanation');
            const sendMessageSection = document.getElementById('sendMessageSection');

            // V√©rifier si l'anniversaire de l'utilisateur approche
            if (currentUserBirthday) {
                const days = daysUntilBirthday(currentUserBirthday);
                if (days !== null && days >= 0 && days <= 7) {
                    birthdayExplanation.classList.remove('hidden');
                } else {
                    birthdayExplanation.classList.add('hidden');
                }
            }

            // Charger les anniversaires √† venir pour envoyer des messages
            loadUpcomingBirthdays();

            // Charger les messages re√ßus
            if (!currentUserId) {
                messagesList.innerHTML = '<p class="text-gray-500 text-center py-8">Erreur : utilisateur non connect√©</p>';
                return;
            }

            try {
                const messagesSnapshot = await firebase.firestore().collection('messages')
                    .where('recipientId', '==', currentUserId)
                    .get();

                if (messagesSnapshot.empty) {
                    messagesList.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun message re√ßu pour le moment.</p>';
                    return;
                }

                // Trier c√¥t√© client pour √©viter le besoin d'index composite
                const messages = messagesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });

                messagesList.innerHTML = '';
                messages.forEach(messageData => {
                    const message = messageData;
                    const messageCard = document.createElement('div');
                    messageCard.className = `message-card p-5 rounded-xl mb-4 ${!message.read ? 'border-l-4 border-primary ring-2 ring-primary ring-opacity-50' : 'opacity-90'}`;
                    
                    const date = message.createdAt?.toDate ? message.createdAt.toDate() : new Date();
                    const formattedDate = date.toLocaleDateString('fr-FR', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    messageCard.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-lg font-bold">
                                        ${(message.senderName || 'A')[0].toUpperCase()}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="font-bold text-lg">${message.senderName || 'Anonyme'}</span>
                                            ${message.isPublic ? 
                                                '<span class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full font-semibold">Public</span>' : 
                                                '<span class="text-xs bg-purple-500 text-white px-3 py-1 rounded-full font-semibold">Secret</span>'
                                            }
                                            ${!message.read ? '<span class="text-xs bg-primary text-white px-2 py-1 rounded-full animate-pulse">Nouveau</span>' : ''}
                                        </div>
                                        <p class="text-xs text-gray-400">${formattedDate}</p>
                                    </div>
                                </div>
                                <div class="bg-bg-dark p-4 rounded-lg border border-gray-700">
                                    <p class="text-gray-200 leading-relaxed">${message.message}</p>
                                </div>
                            </div>
                            ${!message.read ? `
                                <button onclick="markAsRead('${message.id}')" class="ml-4 p-2 rounded-lg bg-primary hover:bg-secondary text-white transition transform hover:scale-110" title="Marquer comme lu">
                                    <i data-lucide="check" class="w-5 h-5"></i>
                                </button>
                            ` : `
                                <div class="ml-4 p-2 rounded-lg bg-gray-700 text-gray-400">
                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                </div>
                            `}
                        </div>
                    `;
                    messagesList.appendChild(messageCard);
                });

                lucide.createIcons();
                loadNotifications(); // Mettre √† jour le badge
            } catch (error) {
                console.error('Erreur lors du chargement des messages:', error);
                messagesList.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement des messages.</p>';
            }
        }

        // Charger la vue des profils (autres √©l√®ves)
        async function loadProfilesView() {
            const profilesContent = document.getElementById('profilesContent');
            const otherProfilesSection = document.getElementById('otherProfilesSection');
            const profilesSeparator = document.getElementById('profilesSeparator');
            
            profilesContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement...</p>';

            try {
                // V√©rifier si la visibilit√© est activ√©e
                const settingsDoc = await firebase.firestore().collection('settings').doc('profileVisibility').get();
                const enabled = settingsDoc.exists && settingsDoc.data().enabled || false;

                if (!enabled) {
                    profilesContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="lock" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                            <p class="text-gray-400">La visibilit√© des profils n'est pas activ√©e pour le moment.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Charger tous les √©l√®ves
                const users = await getAllUsers();
                const students = users.filter(u => u.role === 'eleve' && (u.id !== currentUserId && u.uid !== currentUserId));

                if (students.length === 0) {
                    profilesContent.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun autre √©l√®ve trouv√©.</p>';
                    return;
                }

                // Filtrer seulement ceux qui ont compl√©t√© leur profil
                const studentsWithProfiles = students.filter(s => s.profileCompleted);

                if (studentsWithProfiles.length === 0) {
                    profilesContent.innerHTML = '<p class="text-gray-500 text-center py-8">Aucun √©l√®ve n\'a encore compl√©t√© son profil.</p>';
                    return;
                }

                // Afficher la liste
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                studentsWithProfiles.forEach(student => {
                    const studentId = student.id || student.uid; // Utiliser id (document ID) ou uid en fallback
                    html += `
                        <div class="card p-4 rounded-xl hover:shadow-lg transition cursor-pointer" onclick="viewStudentProfile('${studentId}')">
                            <div class="flex items-center space-x-3 mb-3">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold text-lg">
                                    ${(student.fullName || '?')[0].toUpperCase()}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg">${student.fullName || 'N/A'}</h3>
                                    <p class="text-sm text-gray-400">${student.email || ''}</p>
                                </div>
                            </div>
                            <button class="w-full mt-3 px-4 py-2 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                Voir le profil
                            </button>
                        </div>
                    `;
                });
                html += '</div>';

                profilesContent.innerHTML = html;
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement des profils:', error);
                profilesContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement des profils.</p>';
            }
        }

        // Voir le profil d'un √©l√®ve
        function viewStudentProfile(studentId) {
            window.location.href = `student-profile.html?id=${studentId}`;
        }

        // Liste des mots interdits (filtre de contenu) - Plus de 200 mots
        const forbiddenWords = [
            // Mots vulgaires classiques
            'merde', 'putain', 'con', 'connard', 'conne', 'connasse', 'connasses', 'salope', 'salopes', 'salopard',
            'encul√©', 'enculer', 'encul√©e', 'encul√©es', 'encul√©s', 'bite', 'chier', 'chi√©', 'chiant', 'chiasse',
            'bordel', 'foutre', 'fout', 'foutue', 'foutu', 'foutus', 'foutues', 'pute', 'putes', 'p√©d√©',
            'p√©dale', 'p√©dales', 'tapette', 'tapettes', 'tarlouze', 'tarlouzes', 'p√©dophile', 'p√©dophiles',
            'nique', 'niquer', 'niquez', 'niquent', 'niqu√©', 'niqu√©e', 'niqu√©s', 'niqu√©es', 'niques',
            'salaud', 'salauds', 'salaude', 'salaudes', 'cr√©tin', 'cr√©tine', 'cr√©tins', 'cr√©tines',
            'idiot', 'idiote', 'idiots', 'idiotes', 'd√©bile', 'd√©biles', 'd√©bilit√©', 'imb√©cile', 'imb√©ciles',
            'abruti', 'abrutie', 'abrutis', 'abruties',
            
            // Mots offensants et expressions
            'fdp', 'pd', 'tg', 'tagueule', 'ta gueule', 'ferme ta gueule', 'ferme-la', 'ferme la',
            'va te faire', 'va te faire foutre', 'va te faire enculer', 'va te faire voir', 'va chier',
            'va niquer', 'va te faire niquer', 'casse-toi', 'cassez-vous', 'd√©gage', 'd√©gagez', 'd√©gageons',
            'd√©gag√©', 'd√©gag√©e', 'd√©gag√©s', 'd√©gag√©es', 'barre-toi', 'barrez-vous', 'fous le camp',
            'fous-moi le camp', 'foutez le camp', 'foutez-moi le camp',
            
            // Insultes et termes d√©gradants
            'sous-merde', 'sous-merdes', 'fils de pute', 'fils de putes', 'fille de pute', 'filles de pute',
            'filsdepute', 'filsdeputes', 'fillesdepute', 'fillesdeputes', 'garce', 'garces', 'ordure',
            'ordures', 'racaille', 'railles', 'voyou', 'voyous', 'voyoute', 'voyoutes', 'bandit', 'bandits',
            'bandite', 'bandites', 'criminel', 'criminelle', 'criminels', 'criminelles', 'voleur', 'voleuse',
            'voleurs', 'voleuses',
            
            // Mots modernes/slang offensants
            'ptn', 'nique ta m√®re', 'nique sa m√®re', 'niquez vos m√®res', 'nique ta race', 'nique sa race',
            'niquez vos races', 'nique ta famille', 'nique sa famille', 'niquez vos familles', 'nique ton p√®re',
            'nique son p√®re', 'niquez vos p√®res',
            
            // Termes grossiers
            'baiser', 'bais√©', 'bais√©e', 'bais√©s', 'bais√©es', 'baise', 'baises', 'baisez', 'baisent',
            'baiser', 'cul', 'culs', 'fion', 'fions', 'chatte', 'chattes', 'bite', 'bites', 'zizi',
            'zizis', 'zob', 'zobs', 'queue', 'queues', 'couilles', 'couille', 'couilles', 'testicules',
            'testicule', 'testicules', 'seins', 'sein', 'seins', 'nichons', 'nichon', 'nichons', 't√©tons',
            't√©ton', 't√©tons', 't√©tasses', 't√©tasse', 't√©tasses',
            
            // Insultes racistes et discriminatoires
            'n√®gre', 'n√©gre', 'n√©gresse', 'n√©gres', 'n√©gresses', 'youpin', 'youpine', 'youpins', 'youpines',
            'bougnoule', 'bougnoules', 'bicot', 'bicots', 'bicotte', 'bicottes', 'raton', 'ratons', 'ratonne',
            'ratonnes', 'sale arabe', 'sale noir', 'sale juif', 'sale musulman', 'sale chinois', 'sale asiatique',
            'bougnoul', 'bougnouls', 'bougnoule', 'bougnoules', 'bamboula', 'bamboulas', 'bicot', 'bicots',
            
            // Termes homophobes
            'gouine', 'gouines', 'p√©d√©raste', 'p√©d√©rastes', 'sodomite', 'sodomites', 'tapette', 'tapettes',
            'tarlouze', 'tarlouzes', 'p√©dale', 'p√©dales', 'p√©d√©', 'p√©d√©s',
            
            // Termes sexistes
            'p√©tasse', 'p√©tasses', 'chienne', 'chiennes', 'garce', 'garces', 'connasse', 'connasses',
            'salope', 'salopes', 'pute', 'putes', 'pouffiasse', 'pouffiasses', 'pouffe', 'pouffes',
            'pouffiasse', 'pouffiasses', 'garce', 'garces',
            
            // Mots vulgaires suppl√©mentaires
            'branlette', 'branlettes', 'branler', 'branl√©', 'branl√©e', 'branl√©s', 'branl√©es', 'branle',
            'branles', 'branlez', 'branlent', 'masturber', 'masturb√©', 'masturb√©e', 'masturb√©s', 'masturb√©es',
            'masturbe', 'masturbes', 'masturbez', 'masturbent', 'se branler', 'se masturber', 'branlette',
            'branlettes', 'pomper', 'pomp√©', 'pomp√©e', 'pomp√©s', 'pomp√©es', 'pompe', 'pompes', 'pompez',
            'pompent', 'sucer', 'suc√©', 'suc√©e', 'suc√©s', 'suc√©es', 'suce', 'suces', 'sucez', 'sucent',
            
            // Termes offensants suppl√©mentaires
            'tar√©', 'tar√©e', 'tar√©s', 'tar√©es', 'cingl√©', 'cingl√©e', 'cingl√©s', 'cingl√©es', 'dingue',
            'dingues', 'dingo', 'dingos', 'fou', 'fous', 'folle', 'folles', 'd√©jant√©', 'd√©jant√©e', 'd√©jant√©s',
            'd√©jant√©es', 'malade', 'malades', 'malade mental', 'malades mentaux', 'malade mentale',
            'malades mentales', 'd√©bile mental', 'd√©biles mentaux', 'd√©bile mentale', 'd√©biles mentales',
            
            // Mots offensants modernes (slang)
            'kikoo', 'kikou', 'tg', 'tagueule', 'ta gueule', 'fdp', 'pd', 'ptn', 'ptdr', 'mdr', 'lol',
            'nique', 'niquer', 'niquez', 'niquent', 'niqu√©', 'niqu√©e', 'niqu√©s', 'niqu√©es', 'niques',
            'nique ta m√®re', 'nique sa m√®re', 'niquez vos m√®res', 'nique ta race', 'nique sa race',
            'niquez vos races', 'nique ta famille', 'nique sa famille', 'niquez vos familles',
            
            // Termes violents
            'tuer', 'tu√©', 'tu√©e', 'tu√©s', 'tu√©es', 'tue', 'tues', 'tuez', 'tuent', 'assassiner',
            'assassin√©', 'assassin√©e', 'assassin√©s', 'assassin√©es', 'assassine', 'assassines', 'assassinez',
            'assassinent', 'massacrer', 'massacr√©', 'massacr√©e', 'massacr√©s', 'massacr√©es', 'massacre',
            'massacres', 'massacrez', 'massacrent', '√©gorger', '√©gorg√©', '√©gorg√©e', '√©gorg√©s', '√©gorg√©es',
            '√©gorge', '√©gorges', '√©gorgez', '√©gorgent', 'poignarder', 'poignard√©', 'poignard√©e', 'poignard√©s',
            'poignard√©es', 'poignarde', 'poignardes', 'poignardez', 'poignardent',
            
            // Mots offensants additionnels
            'minable', 'minables', 'nul', 'nulle', 'nuls', 'nulles', 'pourri', 'pourrie', 'pourris',
            'pourries', 'd√©gueulasse', 'd√©gueulasses', 'd√©gueulasse', 'd√©goutant', 'd√©goutante', 'd√©goutants',
            'd√©goutantes', 'd√©go√ªtant', 'd√©go√ªtante', 'd√©go√ªtants', 'd√©go√ªtantes', 'infect', 'infecte',
            'infects', 'infectes', 'immonde', 'immondes', 'ignoble', 'ignobles', 'vile', 'viles', 'bas',
            'basse', 'basses', 'basses', 'm√©prisable', 'm√©prisables', 'honteux', 'honteuse', 'honteux',
            'honteuses', 'l√¢che', 'l√¢ches', 'l√¢che', 'l√¢ches', 'tra√Ætre', 'tra√Ætres', 'tra√Ætresse',
            'tra√Ætresses', 'sale', 'sales', 'sale', 'sales', 'crasseux', 'crasseuse', 'crasseux', 'crasseuses',
            
            // Termes d√©gradants suppl√©mentaires
            'sous-merde', 'sous-merdes', 'sous-race', 'sous-races', 'sous-homme', 'sous-hommes', 'sous-femme',
            'sous-femmes', 'sous-√™tre', 'sous-√™tres', 'sous-humain', 'sous-humains', 'sous-humaine',
            'sous-humaines', 'sous-d√©velopp√©', 'sous-d√©velopp√©s', 'sous-d√©velopp√©e', 'sous-d√©velopp√©es',
            
            // Mots offensants finaux
            'merdeux', 'merdeuse', 'merdeux', 'merdeuses', 'merdique', 'merdiques', 'merdique', 'merdiques',
            'chi√©', 'chi√©e', 'chi√©s', 'chi√©es', 'chiant', 'chiante', 'chiants', 'chiantes', 'chiasse',
            'chiasses', 'chiasse', 'chiasses', 'bord√©lique', 'bord√©liques', 'bord√©lique', 'bord√©liques',
            'foutraque', 'foutraques', 'foutraque', 'foutraques', 'foutriquet', 'foutriquets', 'foutriquet',
            'foutriquets', 'foutriquet', 'foutriquets', 'foutriquet', 'foutriquets'
        ];

        // Fonction de validation des messages (v√©rification des mots interdits)
        function validateMessage(message) {
            if (!message || typeof message !== 'string') {
                return { valid: false, reason: 'Le message est vide ou invalide.' };
            }

            // Normaliser le message (minuscules, sans accents pour certains caract√®res)
            const normalizedMessage = message.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Enlever les accents
                .replace(/[^\w\s]/g, ' '); // Remplacer la ponctuation par des espaces

            // V√©rifier chaque mot interdit
            for (const word of forbiddenWords) {
                const normalizedWord = word.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '');
                
                // V√©rifier si le mot interdit est pr√©sent (mot complet, pas juste une partie)
                const regex = new RegExp(`\\b${normalizedWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                if (regex.test(normalizedMessage)) {
                    return { 
                        valid: false, 
                        reason: `Votre message contient un mot inappropri√©. Veuillez modifier votre message pour qu'il soit respectueux.`,
                        word: word
                    };
                }
            }

            return { valid: true };
        }

        // Messages de bonne f√™te al√©atoires
        const birthdayMessages = [
            "üéâ Joyeux anniversaire ! Que cette nouvelle ann√©e t'apporte plein de bonheur et de r√©ussite !",
            "üéÇ Bon anniversaire ! Profite bien de ta journ√©e sp√©ciale !",
            "üéà Joyeux anniversaire ! Que tous tes r√™ves se r√©alisent !",
            "üéÅ Bonne f√™te ! Passe une superbe journ√©e remplie de joie !",
            "üåü Joyeux anniversaire ! Que cette ann√©e soit la meilleure de toutes !",
            "üéä Bon anniversaire ! Que la chance te sourie toute l'ann√©e !",
            "üéâ Joyeux anniversaire ! Profite de chaque moment de cette journ√©e sp√©ciale !",
            "üéÇ Bonne f√™te ! Que cette nouvelle ann√©e soit remplie de moments magiques !",
            "üéà Joyeux anniversaire ! Que tous tes souhaits se r√©alisent !",
            "üéÅ Bon anniversaire ! Passe une journ√©e inoubliable !",
            "üåü Joyeux anniversaire ! Que cette ann√©e t'apporte plein de bonheur !",
            "üéä Bonne f√™te ! Que tous tes projets se r√©alisent !",
            "üéâ Joyeux anniversaire ! Que cette journ√©e soit remplie de surprises !",
            "üéÇ Bon anniversaire ! Profite bien de ta journ√©e sp√©ciale avec tes proches !",
            "üéà Joyeux anniversaire ! Que cette nouvelle ann√©e soit exceptionnelle !",
            "üéÅ Bonne f√™te ! Que tous tes r√™ves deviennent r√©alit√© !",
            "üåü Joyeux anniversaire ! Que cette ann√©e soit la plus belle !",
            "üéä Bon anniversaire ! Passe une journ√©e magique !",
            "üéâ Joyeux anniversaire ! Que cette journ√©e soit remplie de joie et de rires !",
            "üéÇ Bonne f√™te ! Que cette nouvelle ann√©e t'apporte plein de succ√®s !"
        ];

        // G√©n√©rer un message de bonne f√™te al√©atoire
        window.generateBirthdayMessage = function(celebrationId) {
            const messageTextarea = document.getElementById(`message_${celebrationId}`);
            if (!messageTextarea) return;

            // S√©lectionner un message al√©atoire
            const randomMessage = birthdayMessages[Math.floor(Math.random() * birthdayMessages.length)];
            
            // Remplir le textarea avec le message g√©n√©r√©
            messageTextarea.value = randomMessage;
            
            // Focus sur le textarea pour que l'utilisateur puisse modifier si besoin
            messageTextarea.focus();
            
            // Animation visuelle pour indiquer que le message a √©t√© g√©n√©r√©
            messageTextarea.style.transition = 'all 0.3s ease';
            messageTextarea.style.borderColor = 'var(--secondary)';
            setTimeout(() => {
                messageTextarea.style.borderColor = '';
            }, 1000);
        }

        // Mapping des questions (identique √† student-profile.html)
        const questionLabels = {
            crushSecret: 'Crush secret',
            meilleurAmi: 'Meilleur ami(e)',
            animalPrefere: 'Animal pr√©f√©r√©',
            platPrefere: 'Plat pr√©f√©r√©',
            sportPrefere: 'Sport pr√©f√©r√©',
            musiquePreferee: 'Groupe/artiste de musique pr√©f√©r√©',
            filmPrefere: 'Film pr√©f√©r√©',
            livrePrefere: 'Livre pr√©f√©r√©',
            passeTemps: 'Passe-temps favori',
            qualiteAdmiree: 'Qualit√© admir√©e',
            faitRire: 'Ce qui fait rire',
            superpouvoir: 'Superpouvoir souhait√©',
            endroitEcole: 'Endroit pr√©f√©r√© √† l\'√©cole',
            momentJournee: 'Moment pr√©f√©r√© de la journ√©e',
            metierReve: 'M√©tier de r√™ve',
            emojiPrefere: 'Emoji pr√©f√©r√©',
            couleurPreferee: 'Couleur pr√©f√©r√©e',
            snackPrefere: 'Snack pr√©f√©r√©',
            motivation: 'Ce qui motive',
            reveFou: 'R√™ve fou'
        };

        // Fonction de d√©cryptage (pour afficher le crush secret)
        function decryptCrushSecret(encryptedText, userId) {
            if (!encryptedText || encryptedText.trim() === '') return '';
            
            try {
                const decoded = atob(encryptedText);
                const parts = decoded.split('|');
                if (parts.length !== 2) return encryptedText;
                
                const encrypted = parts[0];
                const key = parseInt(parts[1]);
                
                let decrypted = '';
                for (let i = 0; i < encrypted.length; i++) {
                    const code = encrypted.charCodeAt(i);
                    
                    if (code >= 65 && code <= 90) {
                        let newCode = code - 65 - key;
                        if (newCode < 0) newCode += 26;
                        decrypted += String.fromCharCode(newCode + 65);
                    } else if (code >= 97 && code <= 122) {
                        let newCode = code - 97 - key;
                        if (newCode < 0) newCode += 26;
                        decrypted += String.fromCharCode(newCode + 97);
                    } else {
                        decrypted += encrypted[i];
                    }
                }
                
                return decrypted;
            } catch (error) {
                console.error('Erreur lors du d√©cryptage:', error);
                return encryptedText;
            }
        }


        // Fonctions pour ouvrir/fermer les modales
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                lucide.createIcons();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Ouvrir la modale de modification de profil
        window.openEditProfileModal = function() {
            openModal('editProfileModal');
        }

        // Ouvrir la modale de visibilit√©
        window.openVisibilityModal = async function() {
            openModal('visibilityModal');
            await loadVisibilityModalContent();
        }

        // Charger le contenu de la modale de visibilit√©
        async function loadVisibilityModalContent() {
            const visibilityModalContent = document.getElementById('visibilityModalContent');
            visibilityModalContent.innerHTML = '<p class="text-gray-500 text-center py-8">Chargement...</p>';

            try {
                if (!currentUserId) {
                    visibilityModalContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur : utilisateur non connect√©</p>';
                    return;
                }

                // Charger les donn√©es du profil
                const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
                
                if (!userDoc.exists) {
                    visibilityModalContent.innerHTML = '<p class="text-red-400 text-center py-8">Profil non trouv√©</p>';
                    return;
                }

                const userData = userDoc.data();

                // V√©rifier si le profil est compl√©t√©
                if (!userData.profileCompleted || !userData.profileInfo) {
                    visibilityModalContent.innerHTML = `
                        <div class="text-center py-8">
                            <i data-lucide="user-x" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                            <p class="text-gray-400 mb-4">Tu n'as pas encore rempli ton profil.</p>
                            <button onclick="window.location.href='profile-setup.html'" class="px-6 py-3 rounded-lg bg-primary hover:bg-opacity-90 text-white transition">
                                Remplir mon profil
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Afficher les informations avec toggles
                let html = '<div class="space-y-4">';
                const profileData = userData.profileInfo;

                Object.keys(questionLabels).forEach(key => {
                    if (profileData[key]) {
                        const info = profileData[key];
                        let answer = info.answer || '';
                        const isPublic = info.isPublic || false;
                        const isEncrypted = info.encrypted || false;

                        // D√©crypter le crush secret pour l'affichage
                        if (key === 'crushSecret' && isEncrypted && answer) {
                            answer = decryptCrushSecret(answer, currentUserId);
                        }

                        // Afficher seulement si il y a une r√©ponse
                        if (!answer || answer.trim() === '') {
                            return;
                        }

                        const label = questionLabels[key];
                        const uniqueId = `modal_toggle_${key}`;

                        html += `
                            <div class="card p-4 rounded-xl">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold text-primary mb-1">${label}</h3>
                                        <p class="text-gray-300 text-sm">${answer}</p>
                                    </div>
                                </div>
                                <div class="flex items-center justify-end space-x-3 pt-3 border-t border-gray-700">
                                    <span class="text-sm text-gray-400">Priv√©</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="${uniqueId}" ${isPublic ? 'checked' : ''} class="sr-only peer" onchange="updateProfileVisibility('${key}', this.checked)">
                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                    <span class="text-sm text-gray-400">Public</span>
                                </div>
                            </div>
                        `;
                    }
                });

                html += '</div>';

                if (html === '<div class="space-y-4"></div>') {
                    visibilityModalContent.innerHTML = '<p class="text-gray-500 text-center py-8">Aucune information √† afficher</p>';
                } else {
                    visibilityModalContent.innerHTML = html;
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
                visibilityModalContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement du profil.</p>';
            }
        }

        // Mettre √† jour la visibilit√© d'une information (accessible globalement)
        window.updateProfileVisibility = async function(key, isPublic) {
            try {
                if (!currentUserId) {
                    alert('Erreur : utilisateur non connect√©');
                    return;
                }

                // Mettre √† jour uniquement le flag isPublic pour cette cl√©
                const userRef = firebase.firestore().collection('users').doc(currentUserId);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists || !userDoc.data().profileInfo) {
                    alert('Erreur : profil non trouv√©');
                    return;
                }

                const profileInfo = userDoc.data().profileInfo;
                if (profileInfo[key]) {
                    profileInfo[key].isPublic = isPublic;
                    
                    await userRef.update({
                        'profileInfo': profileInfo
                    });

                    console.log(`‚úÖ Visibilit√© de "${questionLabels[key]}" mise √† jour : ${isPublic ? 'Public' : 'Priv√©'}`);
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour de la visibilit√©:', error);
                alert('Erreur lors de la mise √† jour. Veuillez r√©essayer.');
                // Recharger la modale pour restaurer l'√©tat pr√©c√©dent
                loadVisibilityModalContent();
            }
        }

        // Fermer les modales en cliquant sur l'overlay
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('show');
            }
        });

        // Marquer un message comme lu
        async function markAsRead(messageId) {
            try {
                await firebase.firestore().collection('messages').doc(messageId).update({
                    read: true
                });
                loadNotificationsView();
                loadNotifications();
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du message:', error);
            }
        }

        // D√©connexion
        function signOutAndRedirect() {
            signOutUser().then(() => {
                sessionStorage.clear();
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Erreur de d√©connexion:", error);
            });
        }

        // Aller vers admin
        function goToAdmin() {
            window.location.href = 'admin.html';
        }

        // Initialisation
        // Charger la vue vote
        async function loadVoteView() {
            const voteContent = document.getElementById('voteContent');
            
            if (!currentUserId) {
                voteContent.innerHTML = '<p class="text-red-400 text-center py-8">Vous devez √™tre connect√© pour voter.</p>';
                return;
            }

            // V√©rifier le statut de l'utilisateur
            const userDoc = await firebase.firestore().collection('users').doc(currentUserId).get();
            const userData = userDoc.data();
            const userStatus = userData.status || 'active';

            // Exclure les spectateurs et les utilisateurs bloqu√©s
            if (userStatus === 'spectator' || userStatus === 'blocked') {
                voteContent.innerHTML = `
                    <div class="bg-red-900 bg-opacity-30 border border-red-500 rounded-lg p-4 text-center">
                        <i data-lucide="ban" class="w-8 h-8 mx-auto mb-2 text-red-400"></i>
                        <p class="text-red-400 font-bold">Acc√®s refus√©</p>
                        <p class="text-gray-400 text-sm mt-2">Votre statut (${userStatus === 'spectator' ? 'Spectateur' : 'Bloqu√©'}) ne vous permet pas de participer aux votes.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            try {
                const [activities, settings] = await Promise.all([
                    getAllActivities(),
                    getVoteSettings()
                ]);
                
                const isFinal = settings.finalVotingEnabled;
                const votingEnabled = settings.votingEnabled || settings.finalVotingEnabled;
                
                if (!votingEnabled) {
                    voteContent.innerHTML = `
                        <div class="bg-yellow-900 bg-opacity-30 border border-yellow-500 rounded-lg p-4 text-center">
                            <i data-lucide="lock" class="w-8 h-8 mx-auto mb-2 text-yellow-400"></i>
                            <p class="text-yellow-400 font-bold">Le vote n'est pas encore activ√©</p>
                            <p class="text-gray-400 text-sm mt-2">Attendez que l'administrateur active le vote.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }
                
                if (activities.length === 0) {
                    voteContent.innerHTML = `
                        <div class="bg-gray-800 bg-opacity-30 border border-gray-700 rounded-lg p-4 text-center">
                            <p class="text-gray-400">Aucune activit√© disponible pour le moment.</p>
                        </div>
                    `;
                    return;
                }
                
                // V√©rifier si l'utilisateur a d√©j√† vot√©
                const hasVoted = await hasUserVoted(currentUserId, isFinal);
                const userVote = hasVoted ? await getUserVote(currentUserId, isFinal) : null;
                
                const voteTypeText = isFinal ? 'final' : 'initial';
                const voteTypeLabel = isFinal ? 'Vote Final' : 'Vote Initial';
                
                voteContent.innerHTML = `
                    <div class="mb-4 p-4 bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-blue-400">${voteTypeLabel}</h3>
                                <p class="text-sm text-gray-300 mt-1">
                                    ${isFinal ? 'Votez pour l\'activit√© que vous souhaitez faire !' : 'Votez pour vos activit√©s pr√©f√©r√©es !'}
                                </p>
                            </div>
                            ${hasVoted ? `
                                <span class="px-3 py-1 rounded-full bg-green-500 text-white text-sm font-bold">
                                    ‚úì Vous avez vot√©
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${activities.map(activity => {
                            const isSelected = userVote && userVote.activityId === activity.id;
                            return `
                                <div class="border border-gray-700 rounded-lg p-4 ${isSelected ? 'bg-green-900 bg-opacity-20 border-green-500' : 'bg-gray-800 bg-opacity-20'}">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg mb-1">${activity.name}</h3>
                                            ${activity.description ? `<p class="text-sm text-gray-400">${activity.description}</p>` : ''}
                                        </div>
                                        <button 
                                            onclick="submitVoteForActivity('${activity.id}')" 
                                            ${hasVoted ? 'disabled' : ''}
                                            class="px-6 py-2 rounded-lg ${isSelected ? 'bg-green-600' : 'bg-primary hover:bg-secondary'} text-white font-semibold transition ${hasVoted ? 'opacity-50 cursor-not-allowed' : ''}"
                                        >
                                            ${isSelected ? '‚úì S√©lectionn√©' : 'Voter'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                lucide.createIcons();
            } catch (error) {
                console.error('Erreur lors du chargement du vote:', error);
                voteContent.innerHTML = '<p class="text-red-400 text-center py-8">Erreur lors du chargement du vote.</p>';
            }
        }
        
        // Soumettre un vote pour une activit√©
        async function submitVoteForActivity(activityId) {
            if (!currentUserId) {
                alert('Vous devez √™tre connect√© pour voter.');
                return;
            }
            
            try {
                const settings = await getVoteSettings();
                const isFinal = settings.finalVotingEnabled;
                
                const success = await submitVote(currentUserId, activityId, isFinal);
                
                if (success) {
                    alert('Vote enregistr√© avec succ√®s !');
                    loadVoteView(); // Recharger la vue
                } else {
                    alert('Erreur lors de l\'enregistrement du vote.');
                }
            } catch (error) {
                console.error('Erreur lors de la soumission du vote:', error);
                alert('Erreur lors de la soumission du vote.');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuth();
        });
    </script>
</body>
</html>
